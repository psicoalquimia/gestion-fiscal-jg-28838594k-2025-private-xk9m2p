<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="robots" content="noindex, nofollow"><title>Sistema Fiscal â€” AutÃ³nomo Pro</title><style>:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#222535;--border:#2e3250;--accent:#6c63ff;--accent2:#a78bfa;--text:#e8eaf6;--text2:#9ca3af;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;}*{box-sizing:border-box;margin:0;padding:0;}body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;line-height:1.5;}#setupModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;align-items:center;justify-content:center;}#setupModal.active{display:flex;}.setup-box{background:var(--surface);border:1px solid var(--accent);border-radius:12px;padding:2rem;max-width:500px;width:90%;}header{background:var(--surface);border-bottom:1px solid var(--border);padding:.8rem 1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;position:sticky;top:0;z-index:100;}nav{background:var(--surface2);border-bottom:1px solid var(--border);padding:0 1.5rem;display:flex;gap:.2rem;overflow-x:auto;position:sticky;top:57px;z-index:90;}nav button{background:none;border:none;color:var(--text2);padding:.8rem 1.2rem;cursor:pointer;border-bottom:2px solid transparent;font-size:.9rem;white-space:nowrap;transition:0.2s;}nav button.active{color:var(--accent2);border-bottom-color:var(--accent2);background:rgba(167,139,250,0.05);}main{padding:1.5rem;max-width:1100px;margin:0 auto;}.tab-content{display:none;}.tab-content.active{display:block;}.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1.25rem;margin-bottom:1.25rem;}.dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;margin-bottom:1.5rem;}.dash-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:1.25rem;}.venc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.8rem;}.venc-card{border:1px solid var(--border);border-radius:8px;padding:1rem;background:var(--surface2);cursor:pointer;transition:0.2s;}.venc-card.presentado{border-color:var(--green);background:rgba(16,185,129,0.05);}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.8rem;margin-bottom:1rem;}.full{grid-column:1/-1;}label{display:block;font-size:.8rem;color:var(--text2);margin-bottom:.3rem;}input,select,textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:.6rem .8rem;border-radius:6px;font-size:.9rem;}input:focus{border-color:var(--accent);outline:none;}.btn{padding:.6rem 1.2rem;border-radius:6px;border:none;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;transition:0.2s;}.btn-primary{background:var(--accent);color:white;}.btn-success{background:var(--green);color:white;}.btn-ghost{background:var(--surface2);color:var(--text2);border:1px solid var(--border);}.btn-danger{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid var(--red);}.btn:hover{filter:brightness(1.1);}.table-wrap{overflow-x:auto;margin-top:1rem;}table{width:100%;border-collapse:collapse;font-size:.9rem;}th,td{padding:.75rem 1rem;border-bottom:1px solid var(--border);text-align:left;}th{color:var(--text2);font-weight:500;background:rgba(255,255,255,0.02);}.tag{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:700;text-transform:uppercase;}.tag-green{background:rgba(16,185,129,0.2);color:var(--green);}.tag-yellow{background:rgba(245,158,11,0.2);color:var(--yellow);}.edit-mode-banner{background:rgba(245,158,11,0.1);border:1px solid var(--yellow);color:var(--yellow);padding:.7rem 1rem;border-radius:6px;margin-bottom:1rem;display:none;align-items:center;justify-content:space-between;}.num{font-family:monospace;font-weight:600;}.text-right{text-align:right;}.summary-row{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border);}.summary-row:last-child{border:none;font-weight:700;font-size:1.1rem;color:var(--accent2);}</style></head><body><div id="setupModal"><div class="setup-box"><h2>âš™ï¸ ConfiguraciÃ³n inicial</h2><p style="color:var(--text2);margin-bottom:1.5rem">Indica tus datos para personalizar los informes.</p><div class="form-grid"><div class="full"><label>Nombre Completo</label><input id="cfg-nombre" type="text" placeholder="Tu nombre"></div><div><label>NIF / NIE</label><input id="cfg-nif" type="text" placeholder="12345678X"></div></div><button class="btn btn-primary full" onclick="guardarConfiguracion()">Comenzar</button></div></div><header><div><h1 style="font-size:1.4rem">ğŸ“Š GestiÃ³n Fiscal</h1><div id="headerInfo" style="font-size:.85rem;color:var(--text2)"></div></div><div style="display:flex;gap:.5rem"><button class="btn btn-ghost" onclick="exportarLibroRegistro()">ğŸ“¥ Libro Registro</button></div></header><nav id="mainNav"><button class="active" onclick="cambiarTab(event,'dashboard')">ğŸ  Resumen</button><button onclick="cambiarTab(event,'facturas')">ğŸ§¾ Facturas</button><button onclick="cambiarTab(event,'gastos')">ğŸ’¸ Gastos</button><button onclick="cambiarTab(event,'modelo303')">ğŸ“‹ Mod. 303</button><button onclick="cambiarTab(event,'modelo130')">ğŸ“‹ Mod. 130</button><button onclick="cambiarTab(event,'anuales')">ğŸ“… Anuales (390/190)</button><button onclick="cambiarTab(event,'utilidades')">ğŸ”§ Ajustes</button></nav><main><div id="tab-dashboard" class="tab-content active"><div class="dash-grid" id="dash-grid"></div><div class="card"><h3>ğŸ“… Calendario Fiscal 2025/26</h3><p style="font-size:.85rem;color:var(--text2);margin-bottom:1rem">Haz click para marcar como presentado.</p><div class="venc-grid" id="venc-grid"></div></div></div><div id="tab-facturas" class="tab-content"><div class="card"><div id="fac-edit-banner" class="edit-mode-banner"><span>âœï¸ Editando factura</span><button class="btn btn-ghost" style="padding:.2rem .5rem" onclick="limpiarFormFactura()">Cancelar</button></div><h3 id="fac-form-title">â• Nueva Factura Emitida</h3><div class="form-grid"><div><label>Fecha</label><input id="fac-fecha" type="date"></div><div><label>NÂº Factura</label><input id="fac-num" type="text" placeholder="2025-001"></div><div class="full"><label>Cliente</label><input id="fac-cliente" type="text" placeholder="Nombre del cliente"></div><div><label>Concepto</label><select id="fac-tipo" onchange="autoIvaFactura()"><option value="sesion">SesiÃ³n PsicologÃ­a (Exenta)</option><option value="libro_4">Venta Libro Papel (4%)</option><option value="ebook_21">Venta Ebook / Digital (21%)</option><option value="otros_21">Otros Servicios (21%)</option></select></div><div><label>Base Imponible (â‚¬)</label><input id="fac-base" type="number" step="0.01" oninput="recalcFac()"></div><div><label>IVA (%)</label><input id="fac-iva-pct" type="number" value="0" oninput="recalcFac()"></div><div><label>IRPF (%)</label><select id="fac-irpf-pct" onchange="recalcFac()"><option value="0">0%</option><option value="7">7% (Nuevo AutÃ³nomo)</option><option value="15">15% (General)</option></select></div></div><div class="dash-grid" style="grid-template-columns:1fr 1fr;margin-bottom:1rem"><div class="dash-card" style="padding:.8rem"><label>Cuota IVA</label><div id="fac-iva-val" class="num">0.00 â‚¬</div></div><div class="dash-card" style="padding:.8rem"><label>Total Factura</label><div id="fac-total-val" class="num" style="color:var(--accent2)">0.00 â‚¬</div></div></div><input type="hidden" id="fac-id"><button class="btn btn-primary" onclick="guardarFactura()">Guardar Factura</button></div><div class="card"><h3>ğŸ“‹ Listado de Facturas</h3><div class="table-wrap"><table><thead><tr><th>Fecha</th><th>NÂº</th><th>Cliente</th><th>Base</th><th>IVA</th><th>IRPF</th><th>Total</th><th>AcciÃ³n</th></tr></thead><tbody id="lista-facturas"></tbody></table></div></div></div><div id="tab-gastos" class="tab-content"><div class="card"><div id="gas-edit-banner" class="edit-mode-banner"><span>âœï¸ Editando gasto</span><button class="btn btn-ghost" style="padding:.2rem .5rem" onclick="limpiarFormGasto()">Cancelar</button></div><h3>â• Nuevo Gasto / Compra</h3><div class="form-grid"><div><label>Fecha</label><input id="gas-fecha" type="date"></div><div class="full"><label>Proveedor / Concepto</label><input id="gas-prov" type="text" placeholder="Amazon, Alquiler, Suministros..."></div><div><label>Total Pagado (â‚¬)</label><input id="gas-total" type="number" step="0.01" oninput="recalcGasto()"></div><div><label>IVA Aplicado</label><select id="gas-iva-pct" onchange="recalcGasto()"><option value="21">21% (General)</option><option value="10">10% (Reducido)</option><option value="4">4% (Superreducido)</option><option value="0">0% / Sin IVA / Exento</option></select></div></div><div class="dash-grid" style="grid-template-columns:1fr 1fr;margin-bottom:1rem"><div class="dash-card" style="padding:.8rem"><label>Base Calculada</label><div id="gas-base-val" class="num">0.00 â‚¬</div></div><div class="dash-card" style="padding:.8rem"><label>IVA Deducible</label><div id="gas-iva-val" class="num">0.00 â‚¬</div></div></div><input type="hidden" id="gas-id"><button class="btn btn-primary" onclick="guardarGasto()">Guardar Gasto</button></div><div class="card"><h3>ğŸ“‹ Listado de Gastos</h3><div class="table-wrap"><table><thead><tr><th>Fecha</th><th>Concepto</th><th>Base</th><th>IVA</th><th>Total</th><th>AcciÃ³n</th></tr></thead><tbody id="lista-gastos"></tbody></table></div></div></div><div id="tab-modelo303" class="tab-content"><div class="card"><h3>ğŸ“‹ Borrador Modelo 303 (IVA)</h3><div class="form-grid"><div><label>Trimestre</label><select id="303-tri" onchange="render303()"><option value="1">1Âº Trimestre</option><option value="2">2Âº Trimestre</option><option value="3">3Âº Trimestre</option><option value="4">4Âº Trimestre</option></select></div><div><label>AÃ±o</label><select id="303-anyo" onchange="render303()"><option value="2025">2025</option><option value="2026">2026</option></select></div></div><div id="303-resultado"></div></div></div><div id="tab-modelo130" class="tab-content"><div class="card"><h3>ğŸ“‹ Borrador Modelo 130 (IRPF)</h3><div class="form-grid"><div><label>Trimestre</label><select id="130-tri" onchange="render130()"><option value="1">1Âº Trimestre</option><option value="2">2Âº Trimestre</option><option value="3">3Âº Trimestre</option><option value="4">4Âº Trimestre</option></select></div><div><label>AÃ±o</label><select id="130-anyo" onchange="render130()"><option value="2025">2025</option><option value="2026">2026</option></select></div></div><div id="130-resultado"></div></div></div><div id="tab-anuales" class="tab-content"><div class="card"><h3>ğŸ“… Resumen Anual Modelo 390 (IVA)</h3><div class="form-grid"><div><label>Ejercicio</label><select id="390-anyo" onchange="render390()"><option value="2025">2025</option><option value="2024">2024</option></select></div></div><div id="390-resultado"></div></div><div class="card"><h3>ğŸ“… Informativo Modelo 190 (Retenciones)</h3><p style="font-size:.85rem;color:var(--text2)">Resumen de IRPF retenido en tus facturas (solo si aplica).</p><div id="190-resultado" style="margin-top:1rem"></div></div></div><div id="tab-utilidades" class="tab-content"><div class="card"><h3>ğŸ”§ Utilidades de Datos</h3><div style="display:flex;gap:1rem;flex-wrap:wrap"><button class="btn btn-success" onclick="exportarJSON()">ğŸ’¾ Exportar Backup (JSON)</button><button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">ğŸ“‚ Importar Backup</button><input type="file" id="importFile" style="display:none" onchange="importarJSON(event)"><button class="btn btn-danger" onclick="limpiarTodo()">âš ï¸ Borrar Todo</button></div><div style="margin-top:1.5rem;padding:1rem;background:rgba(255,255,255,0.03);border-radius:8px"><h4>MigraciÃ³n y ReparaciÃ³n</h4><p style="font-size:.85rem;color:var(--text2);margin-bottom:1rem">Si faltan datos de IVA en facturas antiguas tras la actualizaciÃ³n, pulsa este botÃ³n:</p><button class="btn btn-ghost" onclick="repararIvaMigracion()">Reparar IVA en Facturas</button></div></div></div></main><script>let facturas=[],gastos=[],config={},presentados={};function init(){try{facturas=JSON.parse(localStorage.getItem('fisc_fac_v3')||'[]');gastos=JSON.parse(localStorage.getItem('fisc_gas_v3')||'[]');config=JSON.parse(localStorage.getItem('fisc_cfg_v3')||'{}');presentados=JSON.parse(localStorage.getItem('fisc_pres_v3')||'{}');if(!config.nombre)document.getElementById('setupModal').classList.add('active');updateUI();}catch(e){console.error(e);alert('Error al cargar datos. Se intentarÃ¡ reparar.');}}function save(){localStorage.setItem('fisc_fac_v3',JSON.stringify(facturas));localStorage.setItem('fisc_gas_v3',JSON.stringify(gastos));localStorage.setItem('fisc_cfg_v3',JSON.stringify(config));localStorage.setItem('fisc_pres_v3',JSON.stringify(presentados));}function updateUI(){renderHeader();renderDashboard();renderFacturas();renderGastos();}function renderHeader(){const h=document.getElementById('headerInfo');if(config.nombre)h.innerText=`${config.nombre} | ${config.nif}`;else h.innerText='ConfiguraciÃ³n pendiente';}function cambiarTab(e,id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+id).classList.add('active');if(e)e.target.classList.add('active');if(id==='modelo303')render303();if(id==='modelo130')render130();if(id==='anuales')render390();}function renderDashboard(){const fac25=facturas.filter(f=>f.fecha.startsWith('2025'));const gas25=gastos.filter(g=>g.fecha.startsWith('2025'));const ing=fac25.reduce((s,f)=>s+f.base,0);const gas=gas25.reduce((s,g)=>s+g.base,0);const ret=fac25.reduce((s,f)=>s+f.irpf,0);const grid=document.getElementById('dash-grid');grid.innerHTML=`<div class="dash-card"><label>Ingresos Brutos 2025</label><div class="num" style="font-size:1.5rem;color:var(--green)">${ing.toFixed(2)} â‚¬</div></div><div class="dash-card"><label>Gastos Deducibles 2025</label><div class="num" style="font-size:1.5rem;color:var(--red)">${gas.toFixed(2)} â‚¬</div></div><div class="dash-card"><label>Rendimiento Neto</label><div class="num" style="font-size:1.5rem;color:var(--accent2)">${(ing-gas).toFixed(2)} â‚¬</div></div><div class="dash-card"><label>IRPF Retenido</label><div class="num" style="font-size:1.5rem;color:var(--yellow)">${ret.toFixed(2)} â‚¬</div></div>`;const vencs=['4T 2025','1T 2026','2T 2026','3T 2026'];const vGrid=document.getElementById('venc-grid');vGrid.innerHTML=vencs.map(v=>`<div class="venc-card ${presentados[v]?'presentado':''}" onclick="togglePres('${v}')"><strong>${v}</strong><br><span class="tag ${presentados[v]?'tag-green':'tag-yellow'}">${presentados[v]?'Presentado':'Pendiente'}</span></div>`).join('');}function togglePres(v){presentados[v]=!presentados[v];save();renderDashboard();}function autoIvaFactura(){const t=document.getElementById('fac-tipo').value;const i=document.getElementById('fac-iva-pct');if(t==='sesion')i.value=0;else if(t==='libro_4')i.value=4;else i.value=21;recalcFac();}function recalcFac(){const b=parseFloat(document.getElementById('fac-base').value)||0;const p=parseFloat(document.getElementById('fac-iva-pct').value)||0;const r=parseFloat(document.getElementById('fac-irpf-pct').value)||0;const iva=b*(p/100);const irpf=b*(r/100);document.getElementById('fac-iva-val').innerText=iva.toFixed(2)+' â‚¬';document.getElementById('fac-total-val').innerText=(b+iva-irpf).toFixed(2)+' â‚¬';}function guardarFactura(){const id=document.getElementById('fac-id').value;const f={id:id?parseInt(id):Date.now(),fecha:document.getElementById('fac-fecha').value,num:document.getElementById('fac-num').value,cliente:document.getElementById('fac-cliente').value,tipo:document.getElementById('fac-tipo').value,base:parseFloat(document.getElementById('fac-base').value)||0,ivaPct:parseFloat(document.getElementById('fac-iva-pct').value)||0,irpfPct:parseFloat(document.getElementById('fac-irpf-pct').value)||0};f.iva=f.base*(f.ivaPct/100);f.irpf=f.base*(f.irpfPct/100);f.total=f.base+f.iva-f.irpf;if(id){const idx=facturas.findIndex(x=>x.id==id);facturas[idx]=f;}else{facturas.push(f);}save();limpiarFormFactura();updateUI();}function editarFactura(id){const f=facturas.find(x=>x.id==id);document.getElementById('fac-id').value=f.id;document.getElementById('fac-fecha').value=f.fecha;document.getElementById('fac-num').value=f.num;document.getElementById('fac-cliente').value=f.cliente;document.getElementById('fac-tipo').value=f.tipo;document.getElementById('fac-base').value=f.base;document.getElementById('fac-iva-pct').value=f.ivaPct;document.getElementById('fac-irpf-pct').value=f.irpfPct;document.getElementById('fac-edit-banner').style.display='flex';recalcFac();}function limpiarFormFactura(){document.getElementById('fac-id').value='';document.getElementById('fac-edit-banner').style.display='none';['fac-fecha','fac-num','fac-cliente','fac-base'].forEach(id=>document.getElementById(id).value='');document.getElementById('fac-iva-pct').value=0;recalcFac();}function renderFacturas(){const body=document.getElementById('lista-facturas');body.innerHTML=facturas.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(f=>`<tr><td>${f.fecha}</td><td class="num">${f.num}</td><td>${f.cliente}</td><td class="num">${f.base.toFixed(2)}</td><td class="num">${f.iva.toFixed(2)}</td><td class="num">${f.irpf.toFixed(2)}</td><td class="num" style="font-weight:700">${f.total.toFixed(2)}</td><td><button class="btn btn-ghost" style="padding:.3rem" onclick="editarFactura(${f.id})">âœï¸</button><button class="btn btn-ghost" style="padding:.3rem;color:var(--red)" onclick="borrarFactura(${f.id})">ğŸ—‘ï¸</button></td></tr>`).join('');}function borrarFactura(id){if(confirm('Â¿Borrar factura?')){facturas=facturas.filter(x=>x.id!=id);save();updateUI();}}function recalcGasto(){const t=parseFloat(document.getElementById('gas-total').value)||0;const p=parseFloat(document.getElementById('gas-iva-pct').value)||0;const base=t/(1+(p/100));const iva=t-base;document.getElementById('gas-base-val').innerText=base.toFixed(2)+' â‚¬';document.getElementById('gas-iva-val').innerText=iva.toFixed(2)+' â‚¬';}function guardarGasto(){const id=document.getElementById('gas-id').value;const total=parseFloat(document.getElementById('gas-total').value)||0;const pct=parseFloat(document.getElementById('gas-iva-pct').value)||0;const base=total/(1+(pct/100));const g={id:id?parseInt(id):Date.now(),fecha:document.getElementById('gas-fecha').value,prov:document.getElementById('gas-prov').value,total:total,ivaPct:pct,base:base,iva:total-base};if(id){const idx=gastos.findIndex(x=>x.id==id);gastos[idx]=g;}else{gastos.push(g);}save();limpiarFormGasto();updateUI();}function editarGasto(id){const g=gastos.find(x=>x.id==id);document.getElementById('gas-id').value=g.id;document.getElementById('gas-fecha').value=g.fecha;document.getElementById('gas-prov').value=g.prov;document.getElementById('gas-total').value=g.total;document.getElementById('gas-iva-pct').value=g.ivaPct;document.getElementById('gas-edit-banner').style.display='flex';recalcGasto();}function limpiarFormGasto(){document.getElementById('gas-id').value='';document.getElementById('gas-edit-banner').style.display='none';['gas-fecha','gas-prov','gas-total'].forEach(id=>document.getElementById(id).value='');recalcGasto();}function renderGastos(){const body=document.getElementById('lista-gastos');body.innerHTML=gastos.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(g=>`<tr><td>${g.fecha}</td><td>${g.prov}</td><td class="num">${g.base.toFixed(2)}</td><td class="num">${g.iva.toFixed(2)}</td><td class="num" style="font-weight:700">${g.total.toFixed(2)}</td><td><button class="btn btn-ghost" style="padding:.3rem" onclick="editarGasto(${g.id})">âœï¸</button><button class="btn btn-ghost" style="padding:.3rem;color:var(--red)" onclick="borrarGasto(${g.id})">ğŸ—‘ï¸</button></td></tr>`).join('');}function borrarGasto(id){if(confirm('Â¿Borrar gasto?')){gastos=gastos.filter(x=>x.id!=id);save();updateUI();}}function getTri(fecha){const m=parseInt(fecha.split('-')[1]);if(m<=3)return 1;if(m<=6)return 2;if(m<=9)return 3;return 4;}function render303(){const tri=document.getElementById('303-tri').value;const anyo=document.getElementById('303-anyo').value;const fT=facturas.filter(f=>f.fecha.startsWith(anyo) && getTri(f.fecha)==tri);const gT=gastos.filter(g=>g.fecha.startsWith(anyo) && getTri(g.fecha)==tri);const b21=fT.filter(f=>f.ivaPct==21).reduce((s,f)=>s+f.base,0);const b4=fT.filter(f=>f.ivaPct==4).reduce((s,f)=>s+f.base,0);const bEx=fT.filter(f=>f.ivaPct==0).reduce((s,f)=>s+f.base,0);const ivaD=gT.reduce((s,g)=>s+g.iva,0);const res=document.getElementById('303-resultado');res.innerHTML=`<div class="table-wrap"><table><tr><td>IVA Devengado (Ventas)</td><td class="text-right">${(b21*0.21+b4*0.04).toFixed(2)} â‚¬</td></tr><tr><td>IVA Deducible (Gastos)</td><td class="text-right">-${ivaD.toFixed(2)} â‚¬</td></tr><tr style="font-weight:700"><td>Resultado Trimestral</td><td class="text-right">${(b21*0.21+b4*0.04-ivaD).toFixed(2)} â‚¬</td></tr></table></div>`;}function render130(){const tri=document.getElementById('130-tri').value;const anyo=document.getElementById('130-anyo').value;const fA=facturas.filter(f=>f.fecha.startsWith(anyo) && getTri(f.fecha)<=tri);const gA=gastos.filter(g=>g.fecha.startsWith(anyo) && getTri(g.fecha)<=tri);const ing=fA.reduce((s,f)=>s+f.base,0);const gas=gA.reduce((s,g)=>s+g.base,0);const ret=fA.reduce((s,f)=>s+f.irpf,0);const beneficio=ing-gas;const pago=Math.max(0,beneficio*0.20-ret);const res=document.getElementById('130-resultado');res.innerHTML=`<div class="table-wrap"><table><tr><td>Ingresos Acumulados</td><td class="text-right">${ing.toFixed(2)} â‚¬</td></tr><tr><td>Gastos Acumulados</td><td class="text-right">-${gas.toFixed(2)} â‚¬</td></tr><tr><td>Rendimiento Neto</td><td class="text-right">${beneficio.toFixed(2)} â‚¬</td></tr><tr style="font-weight:700"><td>Resultado a Pagar (Aprox)</td><td class="text-right">${pago.toFixed(2)} â‚¬</td></tr></table></div>`;}function render390(){const anyo=document.getElementById('390-anyo').value;const fA=facturas.filter(f=>f.fecha.startsWith(anyo));const b21=fA.filter(f=>f.ivaPct==21).reduce((s,f)=>s+f.base,0);const b4=fA.filter(f=>f.ivaPct==4).reduce((s,f)=>s+f.base,0);const bEx=fA.filter(f=>f.ivaPct==0).reduce((s,f)=>s+f.base,0);const res=document.getElementById('390-resultado');res.innerHTML=`<div class="table-wrap"><table><tr><th>Concepto</th><th>Base</th><th>Cuota</th></tr><tr><td>General 21%</td><td>${b21.toFixed(2)}</td><td>${(b21*0.21).toFixed(2)}</td></tr><tr><td>Superreducido 4%</td><td>${b4.toFixed(2)}</td><td>${(b4*0.04).toFixed(2)}</td></tr><tr><td>Exento</td><td>${bEx.toFixed(2)}</td><td>0.00</td></tr></table></div>`;const retA=fA.reduce((s,f)=>s+f.irpf,0);document.getElementById('190-resultado').innerHTML=`<div class="dash-card">Total IRPF retenido: <strong>${retA.toFixed(2)} â‚¬</strong></div>`;}function exportarLibroRegistro(){let csv='Fecha;Factura;Cliente;Base;IVA;IRPF;Total\n';facturas.forEach(f=>{csv+=`${f.fecha};${f.num};${f.cliente};${f.base.toFixed(2)};${f.iva.toFixed(2)};${f.irpf.toFixed(2)};${f.total.toFixed(2)}\n`});const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='Libro_Registro.csv';a.click();}function exportarJSON(){const data={f:facturas,g:gastos,c:config,p:presentados};const blob=new Blob([JSON.stringify(data)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='backup_fiscal.json';a.click();}function importarJSON(e){const file=e.target.files[0];const reader=new FileReader();reader.onload=function(ev){const d=JSON.parse(ev.target.result);facturas=d.f||[];gastos=d.g||[];config=d.c||{};presentados=d.p||{};save();location.reload();};reader.readAsText(file);}function guardarConfiguracion(){config.nombre=document.getElementById('cfg-nombre').value;config.nif=document.getElementById('cfg-nif').value;if(config.nombre){save();document.getElementById('setupModal').classList.remove('active');updateUI();}}function repararIvaMigracion(){facturas=facturas.map(f=>{if(!f.iva){if(f.tipo==='libro_4')f.ivaPct=4;else if(f.tipo==='sesion')f.ivaPct=0;else f.ivaPct=21;f.iva=f.base*(f.ivaPct/100);f.irpf=f.base*(f.irpfPct/100);f.total=f.base+f.iva-f.irpf;}return f;});save();alert('Reparado');updateUI();}function limpiarTodo(){if(confirm('Â¿Borrar todo?')){localStorage.clear();location.reload();}}document.addEventListener('DOMContentLoaded',init);</script></body></html>

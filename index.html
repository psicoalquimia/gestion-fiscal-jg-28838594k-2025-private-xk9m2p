<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>Sistema de Gesti√≥n Fiscal ‚Äî Aut√≥nomo</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #222535;
    --border: #2e3250;
    --accent: #6c63ff;
    --accent2: #a78bfa;
    --text: #e8eaf6;
    --text2: #9ca3af;
    --green: #10b981;
    --red: #ef4444;
    --yellow: #f59e0b;
    --blue: #3b82f6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 15px; }

  /* SETUP MODAL */
  #setupModal {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    z-index: 9999; align-items: center; justify-content: center;
  }
  #setupModal.active { display: flex; }
  .setup-box {
    background: var(--surface); border: 1px solid var(--accent);
    border-radius: 12px; padding: 2rem; max-width: 520px; width: 90%;
  }
  .setup-box h2 { color: var(--accent2); margin-bottom: .5rem; }
  .setup-box p { color: var(--text2); font-size: .9rem; margin-bottom: 1.5rem; }
  .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .8rem; }
  .setup-grid .full { grid-column: 1/-1; }

  /* HEADER */
  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: .8rem 1.5rem; display: flex; align-items: center;
    justify-content: space-between; gap: 1rem; flex-wrap: wrap;
  }
  header h1 { font-size: 1.1rem; color: var(--accent2); }
  .header-info { font-size: .8rem; color: var(--text2); }
  .header-actions { display: flex; gap: .5rem; }

  /* NAV TABS */
  nav { background: var(--surface2); border-bottom: 1px solid var(--border); padding: 0 1.5rem; display: flex; gap: .2rem; overflow-x: auto; }
  nav button {
    background: none; border: none; color: var(--text2); padding: .75rem 1.1rem;
    cursor: pointer; border-bottom: 2px solid transparent; font-size: .9rem;
    white-space: nowrap; transition: all .2s;
  }
  nav button:hover { color: var(--text); }
  nav button.active { color: var(--accent2); border-bottom-color: var(--accent2); }

  /* MAIN */
  main { padding: 1.5rem; max-width: 1100px; margin: 0 auto; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* CARDS */
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 1.25rem; margin-bottom: 1.25rem;
  }
  .card h3 { color: var(--accent2); margin-bottom: 1rem; font-size: 1rem; }
  .card h4 { color: var(--text); margin: .8rem 0 .4rem; font-size: .9rem; }

  /* DASHBOARD GRID */
  .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.25rem; }
  .dash-card {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 1.1rem; text-align: center;
  }
  .dash-card .label { font-size: .78rem; color: var(--text2); margin-bottom: .4rem; }
  .dash-card .value { font-size: 1.5rem; font-weight: 700; }
  .dash-card .sub { font-size: .75rem; color: var(--text2); margin-top: .3rem; }
  .green { color: var(--green); }
  .red { color: var(--red); }
  .yellow { color: var(--yellow); }
  .blue { color: var(--blue); }

  /* VENCIMIENTOS */
  .venc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .8rem; }
  .venc-card {
    border: 1px solid var(--border); border-radius: 8px; padding: 1rem;
    background: var(--surface2);
  }
  .venc-card.pasado { border-color: var(--red); opacity: .7; }
  .venc-card.proximo { border-color: var(--yellow); }
  .venc-card.futuro { border-color: var(--border); }
  .venc-card.presentado { border-color: var(--green); }
  .venc-card .venc-title { font-weight: 600; margin-bottom: .3rem; }
  .venc-card .venc-fecha { font-size: .85rem; color: var(--text2); }
  .venc-card .venc-estado { font-size: .78rem; margin-top: .4rem; padding: .2rem .5rem; border-radius: 4px; display: inline-block; }
  .badge-presentado { background: rgba(16,185,129,.15); color: var(--green); }
  .badge-pendiente { background: rgba(245,158,11,.15); color: var(--yellow); }
  .badge-pasado { background: rgba(239,68,68,.15); color: var(--red); }
  .badge-futuro { background: rgba(107,99,255,.15); color: var(--accent2); }

  /* FORMS */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: .8rem; margin-bottom: 1rem; }
  .form-grid .full { grid-column: 1/-1; }
  label { display: block; font-size: .8rem; color: var(--text2); margin-bottom: .3rem; }
  input, select, textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    color: var(--text); padding: .55rem .7rem; border-radius: 6px;
    font-size: .88rem; transition: border .2s;
  }
  input:focus, select:focus, textarea:focus {
    outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(108,99,255,.2);
  }
  select option { background: var(--surface2); }

  /* BUTTONS */
  .btn {
    padding: .55rem 1.1rem; border-radius: 6px; border: none; cursor: pointer;
    font-size: .88rem; font-weight: 600; transition: all .2s; display: inline-flex;
    align-items: center; gap: .4rem;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #5a52d5; }
  .btn-success { background: var(--green); color: white; }
  .btn-success:hover { background: #059669; }
  .btn-danger { background: var(--red); color: white; }
  .btn-danger:hover { background: #dc2626; }
  .btn-ghost { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); border-color: var(--accent); }
  .btn-sm { padding: .35rem .7rem; font-size: .8rem; }
  .btn-row { display: flex; gap: .6rem; flex-wrap: wrap; margin-top: .8rem; }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: .85rem; }
  th { background: var(--surface2); color: var(--text2); padding: .6rem .8rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border); }
  td { padding: .6rem .8rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:hover td { background: rgba(255,255,255,.02); }

  /* MODELO CASILLAS */
  .modelo-section { margin-bottom: 1.2rem; }
  .casilla-row {
    display: grid; grid-template-columns: 60px 1fr 140px;
    gap: .5rem; align-items: center; padding: .45rem .6rem;
    border-bottom: 1px solid var(--border); font-size: .87rem;
  }
  .casilla-num { font-weight: 700; color: var(--accent2); font-size: .85rem; }
  .casilla-desc { color: var(--text2); font-size: .8rem; }
  .casilla-val { text-align: right; font-weight: 600; }
  .casilla-row.total-row { background: var(--surface2); border-radius: 6px; margin-top: .4rem; }
  .casilla-row.total-row .casilla-val { color: var(--accent2); font-size: 1rem; }

  /* ALERTS */
  .alert { padding: .75rem 1rem; border-radius: 6px; font-size: .87rem; margin-bottom: .8rem; display: flex; gap: .6rem; align-items: flex-start; }
  .alert-warning { background: rgba(245,158,11,.1); border: 1px solid rgba(245,158,11,.3); color: var(--yellow); }
  .alert-info { background: rgba(59,130,246,.1); border: 1px solid rgba(59,130,246,.3); color: var(--blue); }
  .alert-success { background: rgba(16,185,129,.1); border: 1px solid rgba(16,185,129,.3); color: var(--green); }
  .alert-danger { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.3); color: var(--red); }

  /* TRAMOS */
  .tramo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: .6rem; }
  .tramo-card { border: 1px solid var(--border); border-radius: 6px; padding: .7rem; font-size: .82rem; }
  .tramo-card.activo { border-color: var(--accent); background: rgba(108,99,255,.08); }
  .tramo-titulo { font-weight: 600; margin-bottom: .2rem; }
  .tramo-cuota { color: var(--accent2); font-weight: 700; }

  /* PERIODO SELECTOR */
  .periodo-bar { display: flex; gap: .6rem; align-items: center; flex-wrap: wrap; margin-bottom: 1.2rem; }
  .periodo-bar label { margin: 0; font-size: .85rem; }
  .periodo-bar select, .periodo-bar input { width: auto; }

  /* MISC */
  .separator { border: none; border-top: 1px solid var(--border); margin: 1.2rem 0; }
  .nota { font-size: .78rem; color: var(--text2); font-style: italic; }
  .tag { display: inline-block; padding: .15rem .45rem; border-radius: 4px; font-size: .75rem; font-weight: 600; }
  .tag-green { background: rgba(16,185,129,.15); color: var(--green); }
  .tag-red { background: rgba(239,68,68,.15); color: var(--red); }
  .tag-yellow { background: rgba(245,158,11,.15); color: var(--yellow); }
  .tag-blue { background: rgba(59,130,246,.15); color: var(--blue); }
  .tag-purple { background: rgba(108,99,255,.15); color: var(--accent2); }

  @media (max-width: 600px) {
    header { flex-direction: column; align-items: flex-start; }
    .setup-grid { grid-template-columns: 1fr; }
    .casilla-row { grid-template-columns: 50px 1fr; }
    .casilla-val { grid-column: 1/-1; text-align: left; }
  }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL CONFIGURACI√ìN INICIAL (F1)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="setupModal">
  <div class="setup-box">
    <h2>‚öôÔ∏è Configuraci√≥n inicial</h2>
    <p>Introduce tus datos como aut√≥nomo. Se guardar√°n solo en este navegador (localStorage) y nunca aparecer√°n en el c√≥digo fuente.</p>
    <div class="setup-grid">
      <div class="full"><label>Nombre completo *</label><input id="cfg-nombre" type="text" placeholder="Tu nombre completo"></div>
      <div><label>NIF / NIE *</label><input id="cfg-nif" type="text" placeholder="12345678X" maxlength="10"></div>
      <div><label>Fecha de alta en Hacienda *</label><input id="cfg-alta" type="date"></div>
      <div class="full"><label>Actividad econ√≥mica *</label><input id="cfg-actividad" type="text" placeholder="Ej: Servicios de psicolog√≠a y autor literario"></div>
      <div><label>Ep√≠grafe IAE</label><input id="cfg-epigrafe" type="text" placeholder="Ej: 852 / 899"></div>
      <div><label>R√©gimen fiscal</label>
        <select id="cfg-regimen">
          <option value="estimacion_directa_simplificada">Estimaci√≥n Directa Simplificada</option>
          <option value="estimacion_directa_normal">Estimaci√≥n Directa Normal</option>
        </select>
      </div>
      <div class="full"><label>Direcci√≥n (solo para facturas ‚Äî no se sube a ning√∫n servidor)</label><input id="cfg-direccion" type="text" placeholder="Calle, n√∫mero, piso"></div>
      <div><label>Municipio</label><input id="cfg-municipio" type="text" placeholder="Sevilla"></div>
      <div><label>CP</label><input id="cfg-cp" type="text" placeholder="41001" maxlength="5"></div>
      <div><label>Provincia</label><input id="cfg-provincia" type="text" placeholder="Sevilla"></div>
    </div>
    <div class="btn-row" style="margin-top:1.2rem">
      <button class="btn btn-primary" onclick="guardarConfiguracion()">üíæ Guardar y comenzar</button>
    </div>
    <p class="nota" style="margin-top:.8rem">* Campos obligatorios. Puedes editar estos datos en cualquier momento desde la pesta√±a "Utilidades".</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     HEADER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header>
  <div>
    <h1>üìä Sistema de Gesti√≥n Fiscal ‚Äî Aut√≥nomo</h1>
    <div class="header-info" id="headerInfo">Cargando...</div>
  </div>
  <div class="header-actions">
    <button class="btn btn-ghost btn-sm" onclick="exportarDatos()">‚¨áÔ∏è Exportar</button>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Importar</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarDatos(event)">
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     NAV TABS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav id="mainNav">
  <button class="active" onclick="cambiarTab(event,'dashboard')">üè† Resumen</button>
  <button onclick="cambiarTab(event,'facturas')">üßæ Facturas</button>
  <button onclick="cambiarTab(event,'gastos')">üí∏ Gastos</button>
  <button onclick="cambiarTab(event,'modelo303')">üìã Mod. 303 IVA</button>
  <button onclick="cambiarTab(event,'modelo130')">üìã Mod. 130 IRPF</button>
  <button onclick="cambiarTab(event,'modelo349')">üìã Mod. 349</button>
  <button onclick="cambiarTab(event,'autonomos')">üë§ Cuota Aut√≥nomos</button>
  <button onclick="cambiarTab(event,'utilidades')">üîß Utilidades</button>
</nav>

<main>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: DASHBOARD
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-dashboard" class="tab-content active">
  <div id="alertas-dashboard"></div>
  <div class="dash-grid" id="dash-grid"></div>

  <div class="card">
    <h3>üìÖ Calendario fiscal <span id="dash-anyo"></span></h3>
    <div class="venc-grid" id="venc-grid"></div>
    <p class="nota" style="margin-top:.8rem">Los vencimientos se calculan autom√°ticamente. Marca como "Presentado" en cada modelo cuando lo hayas tramitado.</p>
  </div>

  <div class="card">
    <h3>üìä Ingresos vs Gastos ‚Äî A√±o en curso</h3>
    <canvas id="chartResumen" height="80"></canvas>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: FACTURAS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-facturas" class="tab-content">
  <div class="card">
    <h3>‚ûï Nueva factura</h3>
    <div class="form-grid">
      <div><label>N√∫mero de factura</label><input id="fac-num" type="text" placeholder="Ej: 2026/001" oninput="normalizarNumFac()"></div>
      <div><label>Fecha de emisi√≥n *</label><input id="fac-fecha" type="date"></div>
      <div class="full"><label>Cliente / Pagador *</label><input id="fac-cliente" type="text" placeholder="Nombre o raz√≥n social"></div>
      <div><label>Pa√≠s del cliente *</label>
        <select id="fac-pais" onchange="actualizarIvaLabel()">
          <option value="ES">Espa√±a</option>
          <option value="EU">Uni√≥n Europea (con NIF intracomunitario)</option>
          <option value="EX">Fuera de la UE / Extracomunitario</option>
        </select>
      </div>
      <div><label>NIF / VAT del cliente (si aplica)</label><input id="fac-nif-cliente" type="text" placeholder="Ej: ES-B12345678 / ESxxxxxxxx"></div>
      <div><label>Concepto *</label><input id="fac-concepto" type="text" placeholder="Descripci√≥n del servicio"></div>
      <div><label>Tipo de servicio</label>
        <select id="fac-tipo">
          <option value="sesion_terapia">Sesi√≥n de psicolog√≠a / terapia</option>
          <option value="supervision">Supervisi√≥n / formaci√≥n</option>
          <option value="royalties_libro">Royalties libro (Amazon KDP)</option>
          <option value="royalties_apple">Royalties libro (Apple Books)</option>
          <option value="servicio_digital">Servicio digital / plataforma (Upwork, etc.)</option>
          <option value="otro">Otro</option>
        </select>
      </div>
      <div><label>Base imponible (‚Ç¨) *</label><input id="fac-base" type="number" step="0.01" min="0" placeholder="0.00" oninput="calcularTotalesFac()"></div>
      <div>
        <label id="fac-iva-label">IVA (%)</label>
        <select id="fac-iva-pct" onchange="calcularTotalesFac()">
          <option value="21">21% ‚Äî General</option>
          <option value="10">10% ‚Äî Reducido</option>
          <option value="4">4% ‚Äî Superreducido</option>
          <option value="0">0% ‚Äî Exento / Inversi√≥n sujeto pasivo / Extracomunitario</option>
        </select>
      </div>
      <div><label>IRPF Retenci√≥n (%)</label>
        <select id="fac-irpf-pct" onchange="calcularTotalesFac()">
          <option value="0">0% ‚Äî Sin retenci√≥n</option>
          <option value="7">7% ‚Äî Nuevos aut√≥nomos (1er y 2¬∫ a√±o)</option>
          <option value="15">15% ‚Äî General aut√≥nomo</option>
          <option value="19">19% ‚Äî Arrendamientos, etc.</option>
        </select>
      </div>
      <div><label>M√©todo de cobro</label>
        <select id="fac-metodo">
          <option value="stripe">Stripe</option>
          <option value="transferencia">Transferencia bancaria</option>
          <option value="efectivo">Efectivo</option>
          <option value="paypal">PayPal</option>
          <option value="otro">Otro</option>
        </select>
      </div>
      <div><label>Estado</label>
        <select id="fac-estado">
          <option value="cobrada">Cobrada</option>
          <option value="pendiente">Pendiente de cobro</option>
          <option value="anulada">Anulada</option>
        </select>
      </div>
    </div>
    <div id="fac-resumen-calc" style="display:none; background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:.8rem; margin-bottom:.8rem; font-size:.87rem;">
      <div id="fac-calc-lines"></div>
    </div>
    <div id="fac-aviso-regimen" class="alert alert-info" style="display:none"></div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="guardarFactura()">üíæ Guardar factura</button>
      <button class="btn btn-ghost" onclick="limpiarFormFactura()">‚úñ Limpiar</button>
    </div>
  </div>

  <div class="card">
    <h3>üìã Facturas registradas</h3>
    <div class="periodo-bar">
      <label>A√±o:</label>
      <select id="fac-filtro-anyo" onchange="renderFacturas()">
        <option value="todos">Todos</option>
      </select>
      <label>Trimestre:</label>
      <select id="fac-filtro-trim" onchange="renderFacturas()">
        <option value="todos">Todos</option>
        <option value="1">T1 (Ene‚ÄìMar)</option>
        <option value="2">T2 (Abr‚ÄìJun)</option>
        <option value="3">T3 (Jul‚ÄìSep)</option>
        <option value="4">T4 (Oct‚ÄìDic)</option>
      </select>
      <label>Estado:</label>
      <select id="fac-filtro-estado" onchange="renderFacturas()">
        <option value="todos">Todos</option>
        <option value="cobrada">Cobradas</option>
        <option value="pendiente">Pendientes</option>
        <option value="anulada">Anuladas</option>
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>N¬∫</th><th>Fecha</th><th>Cliente</th><th>Base</th><th>IVA</th><th>IRPF</th><th>Total</th><th>Estado</th><th></th></tr></thead>
        <tbody id="tabla-facturas"></tbody>
      </table>
    </div>
    <div id="fac-totales" style="margin-top:.8rem; font-size:.87rem; color:var(--text2);"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: GASTOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-gastos" class="tab-content">
  <div class="card">
    <h3>‚ûï Nuevo gasto</h3>
    <div class="form-grid">
      <div><label>Fecha *</label><input id="gas-fecha" type="date"></div>
      <div><label>Proveedor / Concepto *</label><input id="gas-proveedor" type="text" placeholder="Nombre del proveedor o concepto"></div>
      <div><label>Categor√≠a *</label>
        <select id="gas-categoria" onchange="mostrarAvisoCuotaAutonomos()">
          <option value="cuota_autonomos">Cuota de aut√≥nomos (TGSS)</option>
          <option value="alquiler_local">Alquiler local / despacho</option>
          <option value="suministros">Suministros (luz, internet, etc.)</option>
          <option value="material_oficina">Material de oficina</option>
          <option value="formacion">Formaci√≥n y libros</option>
          <option value="publicidad">Publicidad y marketing</option>
          <option value="software">Software y suscripciones</option>
          <option value="telefono">Tel√©fono y comunicaciones</option>
          <option value="transporte">Transporte y dietas</option>
          <option value="seguros">Seguros profesionales</option>
          <option value="asesoria">Asesor√≠a / servicios profesionales</option>
          <option value="amortizacion">Amortizaciones</option>
          <option value="otro">Otro gasto deducible</option>
        </select>
      </div>
      <div><label>Importe con IVA (‚Ç¨) *</label><input id="gas-total" type="number" step="0.01" min="0" placeholder="0.00" oninput="calcularGastoBase()"></div>
      <div><label>IVA soportado (%)</label>
        <select id="gas-iva-pct" onchange="calcularGastoBase()">
          <option value="21">21%</option>
          <option value="10">10%</option>
          <option value="4">4%</option>
          <option value="0">0% / Sin IVA</option>
        </select>
      </div>
      <div><label>Base imponible (‚Ç¨)</label><input id="gas-base" type="number" step="0.01" placeholder="Calculado autom√°tico" readonly></div>
      <div><label>N¬∫ factura / ticket</label><input id="gas-nfactura" type="text" placeholder="Referencia del justificante"></div>
      <div><label>Deducible</label>
        <select id="gas-deducible">
          <option value="100">100% deducible</option>
          <option value="50">50% (uso mixto)</option>
          <option value="0">No deducible</option>
        </select>
      </div>
      <div class="full"><label>Notas</label><input id="gas-notas" type="text" placeholder="Observaciones opcionales"></div>
    </div>
    <div id="gas-aviso-cuota" class="alert alert-info" style="display:none">
      <div>
        <strong>Cuota de aut√≥nomos:</strong> Para 2025-2026 se aplica el sistema de cotizaci√≥n por ingresos reales. Consulta la pesta√±a <strong>Cuota Aut√≥nomos</strong> para verificar el tramo que corresponde a tus ingresos y si puedes solicitar cambio de tramo a la TGSS.
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="guardarGasto()">üíæ Guardar gasto</button>
      <button class="btn btn-ghost" onclick="limpiarFormGasto()">‚úñ Limpiar</button>
    </div>
  </div>

  <div class="card">
    <h3>üìã Gastos registrados</h3>
    <div class="periodo-bar">
      <label>A√±o:</label>
      <select id="gas-filtro-anyo" onchange="renderGastos()">
        <option value="todos">Todos</option>
      </select>
      <label>Trimestre:</label>
      <select id="gas-filtro-trim" onchange="renderGastos()">
        <option value="todos">Todos</option>
        <option value="1">T1</option><option value="2">T2</option>
        <option value="3">T3</option><option value="4">T4</option>
      </select>
      <label>Categor√≠a:</label>
      <select id="gas-filtro-cat" onchange="renderGastos()">
        <option value="todos">Todas</option>
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Fecha</th><th>Proveedor</th><th>Categor√≠a</th><th>Base</th><th>IVA</th><th>Total</th><th>Deducible</th><th></th></tr></thead>
        <tbody id="tabla-gastos"></tbody>
      </table>
    </div>
    <div id="gas-totales" style="margin-top:.8rem; font-size:.87rem; color:var(--text2);"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: MODELO 303
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-modelo303" class="tab-content">
  <div class="card">
    <h3>üìã Modelo 303 ‚Äî Autoliquidaci√≥n del IVA</h3>
    <p class="nota" style="margin-bottom:1rem">Selecciona el periodo para calcular autom√°ticamente el modelo. Los importes se calculan sobre facturas <strong>cobradas</strong> y gastos del periodo indicado.</p>
    <div class="periodo-bar">
      <label>A√±o:</label>
      <select id="m303-anyo" onchange="calcularModelo303()"><option>2026</option><option>2025</option></select>
      <label>Trimestre:</label>
      <select id="m303-trim" onchange="calcularModelo303()">
        <option value="1">1T (Ene‚ÄìMar)</option><option value="2">2T (Abr‚ÄìJun)</option>
        <option value="3">3T (Jul‚ÄìSep)</option><option value="4">4T (Oct‚ÄìDic)</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="calcularModelo303()">üîÑ Recalcular</button>
    </div>
    <div id="m303-alertas"></div>

    <h4>IVA DEVENGADO (IVA repercutido en tus facturas)</h4>
    <div class="modelo-section" id="m303-devengado"></div>

    <h4>IVA DEDUCIBLE (IVA soportado en tus gastos)</h4>
    <div class="modelo-section" id="m303-deducible"></div>

    <h4>RESULTADO</h4>
    <div class="modelo-section" id="m303-resultado"></div>

    <div class="btn-row">
      <button class="btn btn-success" onclick="marcarPresentado('303')">‚úÖ Marcar como presentado</button>
      <button class="btn btn-ghost" onclick="window.print()">üñ® Imprimir / PDF</button>
    </div>
    <p class="nota" style="margin-top:.8rem">‚ö†Ô∏è Este sistema calcula los importes para orientarte. Verifica siempre los datos en la sede electr√≥nica de la AEAT antes de presentar.</p>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: MODELO 130
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-modelo130" class="tab-content">
  <div class="card">
    <h3>üìã Modelo 130 ‚Äî Pago fraccionado del IRPF</h3>
    <p class="nota" style="margin-bottom:1rem">El Modelo 130 se calcula de forma <strong>acumulada desde el 1 de enero</strong> hasta el final del trimestre seleccionado, como exige Hacienda.</p>
    <div class="periodo-bar">
      <label>A√±o:</label>
      <select id="m130-anyo" onchange="calcularModelo130()"><option>2026</option><option>2025</option></select>
      <label>Trimestre:</label>
      <select id="m130-trim" onchange="calcularModelo130()">
        <option value="1">1T (acumulado Ene‚ÄìMar)</option>
        <option value="2">2T (acumulado Ene‚ÄìJun)</option>
        <option value="3">3T (acumulado Ene‚ÄìSep)</option>
        <option value="4">4T (acumulado Ene‚ÄìDic)</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="calcularModelo130()">üîÑ Recalcular</button>
    </div>
    <div id="m130-alertas"></div>
    <div class="modelo-section" id="m130-casillas"></div>
    <div class="btn-row">
      <button class="btn btn-success" onclick="marcarPresentado('130')">‚úÖ Marcar como presentado</button>
      <button class="btn btn-ghost" onclick="window.print()">üñ® Imprimir / PDF</button>
    </div>
    <p class="nota" style="margin-top:.8rem">‚ö†Ô∏è Si m√°s del 70% de tus ingresos llevan retenci√≥n del 15% de IRPF, est√°s exento de presentar el Mod. 130. El sistema te avisa autom√°ticamente.</p>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: MODELO 349
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-modelo349" class="tab-content">
  <div class="card">
    <h3>üìã Modelo 349 ‚Äî Operaciones intracomunitarias</h3>
    <p class="nota" style="margin-bottom:1rem">Solo debes presentarlo si has realizado operaciones con clientes de la UE que tengan NIF intracomunitario (inversi√≥n del sujeto pasivo).</p>
    <div class="periodo-bar">
      <label>A√±o:</label>
      <select id="m349-anyo" onchange="calcularModelo349()"><option>2026</option><option>2025</option></select>
      <label>Trimestre:</label>
      <select id="m349-trim" onchange="calcularModelo349()">
        <option value="1">1T</option><option value="2">2T</option>
        <option value="3">3T</option><option value="4">4T</option>
      </select>
      <button class="btn btn-ghost btn-sm" onclick="calcularModelo349()">üîÑ Recalcular</button>
    </div>
    <div id="m349-contenido"></div>
    <div class="btn-row">
      <button class="btn btn-success" onclick="marcarPresentado('349')">‚úÖ Marcar como presentado</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: CUOTA AUT√ìNOMOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-autonomos" class="tab-content">
  <div class="card">
    <h3>üë§ Cuota de aut√≥nomos ‚Äî Cotizaci√≥n por ingresos reales (2025‚Äì2026)</h3>
    <p class="nota" style="margin-bottom:1rem">El sistema de cotizaci√≥n por ingresos reales tiene 15 tramos. Introduce tu rendimiento neto estimado anual para ver en qu√© tramo est√°s y cu√°l es tu cuota m√≠nima y m√°xima.</p>

    <div class="form-grid" style="max-width:400px">
      <div><label>Rendimiento neto anual estimado (‚Ç¨)</label>
        <input id="aut-rendimiento" type="number" step="100" placeholder="Ej: 8000" oninput="calcularCuotaAutonomos()">
      </div>
    </div>
    <div id="aut-tramo-activo" style="margin:.8rem 0"></div>
    <div id="aut-alertas"></div>

    <hr class="separator">
    <h4>Tabla completa de tramos 2025‚Äì2026</h4>
    <div class="tramo-grid" id="tramo-grid"></div>
    <p class="nota" style="margin-top:.8rem">Puedes solicitar cambio de tramo a la TGSS hasta 6 veces al a√±o cuando tus ingresos var√≠en. Si en diciembre tu rendimiento real difiere del estimado, Hacienda regulariza la diferencia.</p>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     TAB: UTILIDADES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="tab-utilidades" class="tab-content">
  <div class="card">
    <h3>‚öôÔ∏è Mis datos de configuraci√≥n</h3>
    <div class="form-grid">
      <div class="full"><label>Nombre completo</label><input id="util-nombre" type="text"></div>
      <div><label>NIF / NIE</label><input id="util-nif" type="text"></div>
      <div><label>Fecha de alta en Hacienda</label><input id="util-alta" type="date"></div>
      <div class="full"><label>Actividad econ√≥mica</label><input id="util-actividad" type="text"></div>
      <div><label>Ep√≠grafe IAE</label><input id="util-epigrafe" type="text"></div>
      <div><label>R√©gimen fiscal</label>
        <select id="util-regimen">
          <option value="estimacion_directa_simplificada">Estimaci√≥n Directa Simplificada</option>
          <option value="estimacion_directa_normal">Estimaci√≥n Directa Normal</option>
        </select>
      </div>
      <div class="full"><label>Direcci√≥n</label><input id="util-direccion" type="text"></div>
      <div><label>Municipio</label><input id="util-municipio" type="text"></div>
      <div><label>CP</label><input id="util-cp" type="text"></div>
      <div><label>Provincia</label><input id="util-provincia" type="text"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="actualizarConfiguracion()">üíæ Guardar cambios</button>
      <button class="btn btn-danger" onclick="limpiarConfiguracion()">üóë Limpiar configuraci√≥n</button>
    </div>
  </div>

  <div class="card">
    <h3>üóÇ Gesti√≥n de datos</h3>
    <div class="btn-row">
      <button class="btn btn-ghost" onclick="exportarDatos()">‚¨áÔ∏è Exportar todo a JSON</button>
      <button class="btn btn-ghost" onclick="document.getElementById('importFile2').click()">‚¨ÜÔ∏è Importar desde JSON</button>
      <input type="file" id="importFile2" accept=".json" style="display:none" onchange="importarDatos(event)">
    </div>
    <p class="nota" style="margin-top:.8rem">Haz una copia de seguridad peri√≥dica exportando el JSON. Gu√°rdalo en un lugar seguro (no en GitHub).</p>
    <hr class="separator">
    <h4>‚ö†Ô∏è Zona de peligro</h4>
    <div class="btn-row">
      <button class="btn btn-danger btn-sm" onclick="borrarTodosLosDatos()">üóë Borrar TODOS los datos</button>
    </div>
  </div>

  <div class="card">
    <h3>‚ÑπÔ∏è Informaci√≥n sobre seguridad</h3>
    <div class="alert alert-info">
      <div>
        <strong>Este sistema es 100% local.</strong> Todos tus datos (facturas, gastos, configuraci√≥n) se almacenan √∫nicamente en el <code>localStorage</code> de este navegador. Ning√∫n dato se env√≠a a ning√∫n servidor. El c√≥digo fuente en GitHub no contiene ning√∫n dato personal tuyo.
      </div>
    </div>
    <div class="alert alert-warning">
      <div>
        <strong>Haz copias de seguridad.</strong> El localStorage puede borrarse si limpias los datos del navegador. Exporta tu JSON regularmente y gu√°rdalo en local (no lo subas a GitHub).
      </div>
    </div>
  </div>
</div>

</main>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATOS Y ESTADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let facturas = [];
let gastos = [];
let estadosModelos = {};
let config = {};

function cargarDatos() {
  try { facturas = JSON.parse(localStorage.getItem('facturas_v2') || '[]'); } catch(e) { facturas = []; }
  try { gastos = JSON.parse(localStorage.getItem('gastos_v2') || '[]'); } catch(e) { gastos = []; }
  try { estadosModelos = JSON.parse(localStorage.getItem('estadosModelos_v2') || '{}'); } catch(e) { estadosModelos = {}; }
  try { config = JSON.parse(localStorage.getItem('configAutonomo') || '{}'); } catch(e) { config = {}; }
}

function guardarEnStorage() {
  localStorage.setItem('facturas_v2', JSON.stringify(facturas));
  localStorage.setItem('gastos_v2', JSON.stringify(gastos));
  localStorage.setItem('estadosModelos_v2', JSON.stringify(estadosModelos));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// F1: CONFIGURACI√ìN SIN DATOS EN C√ìDIGO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function verificarConfiguracion() {
  if (!config.nombre || !config.nif) {
    document.getElementById('setupModal').classList.add('active');
  } else {
    actualizarHeaderInfo();
    cargarFormularioConfig();
  }
}

function guardarConfiguracion() {
  const nombre = document.getElementById('cfg-nombre').value.trim();
  const nif = document.getElementById('cfg-nif').value.trim();
  const actividad = document.getElementById('cfg-actividad').value.trim();
  if (!nombre || !nif || !actividad) {
    alert('Por favor rellena al menos nombre, NIF y actividad.'); return;
  }
  config = {
    nombre, nif,
    alta: document.getElementById('cfg-alta').value,
    actividad,
    epigrafe: document.getElementById('cfg-epigrafe').value.trim(),
    regimen: document.getElementById('cfg-regimen').value,
    direccion: document.getElementById('cfg-direccion').value.trim(),
    municipio: document.getElementById('cfg-municipio').value.trim(),
    cp: document.getElementById('cfg-cp').value.trim(),
    provincia: document.getElementById('cfg-provincia').value.trim()
  };
  localStorage.setItem('configAutonomo', JSON.stringify(config));
  document.getElementById('setupModal').classList.remove('active');
  actualizarHeaderInfo();
  cargarFormularioConfig();
  renderDashboard();
}

function actualizarConfiguracion() {
  config = {
    nombre: document.getElementById('util-nombre').value.trim(),
    nif: document.getElementById('util-nif').value.trim(),
    alta: document.getElementById('util-alta').value,
    actividad: document.getElementById('util-actividad').value.trim(),
    epigrafe: document.getElementById('util-epigrafe').value.trim(),
    regimen: document.getElementById('util-regimen').value,
    direccion: document.getElementById('util-direccion').value.trim(),
    municipio: document.getElementById('util-municipio').value.trim(),
    cp: document.getElementById('util-cp').value.trim(),
    provincia: document.getElementById('util-provincia').value.trim()
  };
  localStorage.setItem('configAutonomo', JSON.stringify(config));
  actualizarHeaderInfo();
  alert('‚úÖ Configuraci√≥n guardada.');
}

function limpiarConfiguracion() {
  if (confirm('¬øLimpiar tu configuraci√≥n? Tendr√°s que volver a introducir tus datos.')) {
    localStorage.removeItem('configAutonomo');
    config = {};
    document.getElementById('setupModal').classList.add('active');
  }
}

function actualizarHeaderInfo() {
  document.getElementById('headerInfo').textContent = config.nombre 
    ? `${config.nombre} ¬∑ NIF: ${config.nif} ¬∑ ${config.actividad || ''}`
    : 'Sin configurar';
}

function cargarFormularioConfig() {
  const campos = ['nombre','nif','alta','actividad','epigrafe','regimen','direccion','municipio','cp','provincia'];
  campos.forEach(c => {
    const el = document.getElementById('util-' + c);
    if (el && config[c]) el.value = config[c];
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVEGACI√ìN TABS (F6 fix: recibe event como par√°metro)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function cambiarTab(event, tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#mainNav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  if (event && event.currentTarget) event.currentTarget.classList.add('active');
  // Recalcular si es un modelo
  if (tabId === 'modelo303') calcularModelo303();
  if (tabId === 'modelo130') calcularModelo130();
  if (tabId === 'modelo349') calcularModelo349();
  if (tabId === 'autonomos') renderTramosAutonomos();
  if (tabId === 'dashboard') renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// F2: VENCIMIENTOS FISCALES DIN√ÅMICOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcularVencimientosTrimestres(anyo) {
  const vencimientos = [
    { trimestre: '4T ' + (anyo-1), mod: ['303','130','349'], fecha: new Date(anyo, 0, 20), label: `4T${anyo-1} ‚Äî 20 enero ${anyo}` },
    { trimestre: '1T ' + anyo,    mod: ['303','130','349'], fecha: new Date(anyo, 3, 20), label: `1T${anyo} ‚Äî 20 abril ${anyo}` },
    { trimestre: '2T ' + anyo,    mod: ['303','130','349'], fecha: new Date(anyo, 6, 20), label: `2T${anyo} ‚Äî 20 julio ${anyo}` },
    { trimestre: '3T ' + anyo,    mod: ['303','130','349'], fecha: new Date(anyo, 9, 20), label: `3T${anyo} ‚Äî 20 octubre ${anyo}` },
  ];
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  vencimientos.forEach(v => {
    const clave = `${v.trimestre}_${v.mod.join('_')}`;
    v.presentado = estadosModelos[clave] === 'presentado';
    v.pasado = v.fecha < hoy;
    v.proximo = !v.presentado && !v.pasado && (v.fecha - hoy) < 30 * 86400000;
  });
  return vencimientos;
}

function proximoVencimiento() {
  const anyo = new Date().getFullYear();
  const todos = calcularVencimientosTrimestres(anyo);
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  return todos.find(v => !v.presentado && v.fecha >= hoy) || null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderDashboard() {
  const anyo = new Date().getFullYear();
  document.getElementById('dash-anyo').textContent = anyo;

  const facAnyo = facturas.filter(f => f.estado !== 'anulada' && getAnyo(f.fecha) === anyo);
  const gasAnyo = gastos.filter(g => getAnyo(g.fecha) === anyo);

  const totalIngresos = facAnyo.reduce((s,f) => s + parseFloat(f.base || 0), 0);
  const totalGastos = gasAnyo.reduce((s,g) => s + parseFloat(g.baseDeducible || g.base || 0), 0);
  const beneficio = totalIngresos - totalGastos;
  const ivaRepercutido = facAnyo.filter(f => f.pais === 'ES').reduce((s,f) => s + parseFloat(f.iva || 0), 0);
  const ivaSoportado = gasAnyo.reduce((s,g) => s + parseFloat(g.ivaSoportado || 0), 0);
  const saldoIva = ivaRepercutido - ivaSoportado;
  const retenciones = facAnyo.reduce((s,f) => s + parseFloat(f.irpf || 0), 0);

  document.getElementById('dash-grid').innerHTML = `
    <div class="dash-card"><div class="label">Ingresos ${anyo}</div><div class="value green">${fmt(totalIngresos)} ‚Ç¨</div><div class="sub">${facAnyo.length} facturas</div></div>
    <div class="dash-card"><div class="label">Gastos deducibles ${anyo}</div><div class="value red">${fmt(totalGastos)} ‚Ç¨</div></div>
    <div class="dash-card"><div class="label">Beneficio neto ${anyo}</div><div class="value ${beneficio>=0?'green':'red'}">${fmt(beneficio)} ‚Ç¨</div></div>
    <div class="dash-card"><div class="label">Saldo IVA (a pagar/devolver)</div><div class="value ${saldoIva>=0?'yellow':'green'}">${fmt(saldoIva)} ‚Ç¨</div></div>
    <div class="dash-card"><div class="label">Retenciones IRPF cobradas</div><div class="value blue">${fmt(retenciones)} ‚Ç¨</div></div>
  `;

  // Vencimientos
  const venc = calcularVencimientosTrimestres(anyo);
  document.getElementById('venc-grid').innerHTML = venc.map(v => {
    let cls = 'futuro', badgeCls = 'badge-futuro', badgeTxt = 'Pr√≥ximo';
    if (v.presentado) { cls = 'presentado'; badgeCls = 'badge-presentado'; badgeTxt = '‚úÖ Presentado'; }
    else if (v.pasado) { cls = 'pasado'; badgeCls = 'badge-pasado'; badgeTxt = '‚ö†Ô∏è Sin presentar'; }
    else if (v.proximo) { cls = 'proximo'; badgeCls = 'badge-pendiente'; badgeTxt = 'üîî Menos de 30 d√≠as'; }
    return `<div class="venc-card ${cls}">
      <div class="venc-title">${v.trimestre}</div>
      <div class="venc-fecha">üìÖ ${v.fecha.toLocaleDateString('es-ES',{day:'numeric',month:'long',year:'numeric'})}</div>
      <div class="venc-fecha">Modelos: ${v.mod.join(', ')}</div>
      <div><span class="venc-estado ${badgeCls}">${badgeTxt}</span></div>
    </div>`;
  }).join('');

  // Alertas
  let alertas = '';
  const pv = proximoVencimiento();
  if (pv) {
    const dias = Math.ceil((pv.fecha - new Date()) / 86400000);
    alertas += `<div class="alert ${dias<=10?'alert-danger':'alert-warning'}">üìÖ Pr√≥ximo vencimiento: <strong>${pv.label}</strong> ‚Äî en ${dias} d√≠as</div>`;
  }
  document.getElementById('alertas-dashboard').innerHTML = alertas;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACTURAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function generarNumFactura() {
  const anyo = new Date().getFullYear();
  const facAnyo = facturas.filter(f => getAnyo(f.fecha) === anyo || (f.num && f.num.startsWith(anyo+'/')) );
  const ultimo = facAnyo.length ? Math.max(...facAnyo.map(f => {
    const p = (f.num || '').split('/'); return p[1] ? parseInt(p[1]) : 0;
  })) : 0;
  return `${anyo}/${String(ultimo+1).padStart(3,'0')}`;
}

function normalizarNumFac() {
  const v = document.getElementById('fac-num').value;
  const anyo = new Date().getFullYear();
  // Validaci√≥n: si cambia de a√±o, avisar
  if (v && v.includes('/')) {
    const parts = v.split('/');
    if (parseInt(parts[0]) !== anyo) {
      document.getElementById('fac-aviso-regimen').style.display = 'block';
      document.getElementById('fac-aviso-regimen').innerHTML = `<strong>Aviso:</strong> El n√∫mero de factura pertenece a un a√±o diferente al actual (${anyo}). Aseg√∫rate de que sea correcto.`;
    } else {
      document.getElementById('fac-aviso-regimen').style.display = 'none';
    }
  }
}

function actualizarIvaLabel() {
  const pais = document.getElementById('fac-pais').value;
  const sel = document.getElementById('fac-iva-pct');
  const label = document.getElementById('fac-iva-label');
  const avisoEl = document.getElementById('fac-aviso-regimen');
  if (pais === 'EU') {
    sel.value = '0'; label.textContent = 'IVA (%)';
    avisoEl.style.display = 'block';
    avisoEl.innerHTML = 'üá™üá∫ <strong>Inversi√≥n del sujeto pasivo (UE):</strong> No repercutes IVA, pero debes declararlo en el Mod. 303 (casillas 10-11) y presentar el <strong>Mod. 349</strong>.';
  } else if (pais === 'EX') {
    sel.value = '0'; label.textContent = 'IVA (%)';
    avisoEl.style.display = 'block';
    avisoEl.innerHTML = 'üåç <strong>Exportaci√≥n extracomunitaria:</strong> Operaci√≥n exenta de IVA (art. 21 LIVA). No presentas Mod. 349 por esto.';
  } else {
    label.textContent = 'IVA (%)';
    avisoEl.style.display = 'none';
  }
  calcularTotalesFac();
}

function calcularTotalesFac() {
  const base = parseFloat(document.getElementById('fac-base').value) || 0;
  const ivaPct = parseFloat(document.getElementById('fac-iva-pct').value) || 0;
  const irpfPct = parseFloat(document.getElementById('fac-irpf-pct').value) || 0;
  const iva = round2(base * ivaPct / 100);
  const irpf = round2(base * irpfPct / 100);
  const total = round2(base + iva - irpf);
  const resEl = document.getElementById('fac-resumen-calc');
  const linesEl = document.getElementById('fac-calc-lines');
  if (base > 0) {
    resEl.style.display = 'block';
    linesEl.innerHTML = `
      <div style="display:flex;justify-content:space-between"><span>Base imponible:</span><span>${fmt(base)} ‚Ç¨</span></div>
      <div style="display:flex;justify-content:space-between"><span>IVA (${ivaPct}%):</span><span>+ ${fmt(iva)} ‚Ç¨</span></div>
      ${irpfPct>0?`<div style="display:flex;justify-content:space-between;color:var(--yellow)"><span>Retenci√≥n IRPF (${irpfPct}%):</span><span>‚Äì ${fmt(irpf)} ‚Ç¨</span></div>`:''}
      <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:.4rem;border-top:1px solid var(--border);padding-top:.4rem"><span>Total a cobrar:</span><span>${fmt(total)} ‚Ç¨</span></div>`;
  } else {
    resEl.style.display = 'none';
  }
}

function guardarFactura() {
  const num = document.getElementById('fac-num').value.trim() || generarNumFactura();
  const fecha = document.getElementById('fac-fecha').value;
  const cliente = document.getElementById('fac-cliente').value.trim();
  const concepto = document.getElementById('fac-concepto').value.trim();
  const base = parseFloat(document.getElementById('fac-base').value);
  if (!fecha || !cliente || !concepto || isNaN(base) || base < 0) {
    alert('Por favor rellena fecha, cliente, concepto e importe.'); return;
  }
  // Validar n√∫mero √∫nico por a√±o
  const anyoFac = getAnyo(fecha);
  const numDuplicado = facturas.find(f => f.num === num && f.num);
  if (numDuplicado) { alert(`Ya existe una factura con el n√∫mero ${num}. Usa un n√∫mero diferente.`); return; }

  const ivaPct = parseFloat(document.getElementById('fac-iva-pct').value) || 0;
  const irpfPct = parseFloat(document.getElementById('fac-irpf-pct').value) || 0;
  const pais = document.getElementById('fac-pais').value;
  const iva = round2(base * ivaPct / 100);
  const irpf = round2(base * irpfPct / 100);
  const total = round2(base + iva - irpf);

  const factura = {
    id: Date.now(), num, fecha, cliente,
    nifCliente: document.getElementById('fac-nif-cliente').value.trim(),
    concepto, tipo: document.getElementById('fac-tipo').value,
    pais, base, ivaPct, iva, irpfPct, irpf, total,
    metodo: document.getElementById('fac-metodo').value,
    estado: document.getElementById('fac-estado').value
  };
  facturas.push(factura);
  guardarEnStorage();
  limpiarFormFactura();
  renderFacturas();
  renderDashboard();
  alert(`‚úÖ Factura ${num} guardada.`);
}

function limpiarFormFactura() {
  ['fac-num','fac-fecha','fac-cliente','fac-nif-cliente','fac-concepto','fac-base'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('fac-iva-pct').value = '21';
  document.getElementById('fac-irpf-pct').value = '0';
  document.getElementById('fac-pais').value = 'ES';
  document.getElementById('fac-estado').value = 'cobrada';
  document.getElementById('fac-resumen-calc').style.display = 'none';
  document.getElementById('fac-aviso-regimen').style.display = 'none';
  // Proponer siguiente n√∫mero
  document.getElementById('fac-num').value = generarNumFactura();
  // Fecha de hoy
  document.getElementById('fac-fecha').value = hoyISO();
}

function eliminarFactura(id) {
  if (!confirm('¬øEliminar esta factura?')) return;
  facturas = facturas.filter(f => f.id !== id);
  guardarEnStorage(); renderFacturas(); renderDashboard();
}

function renderFacturas() {
  const filtroAnyo = document.getElementById('fac-filtro-anyo').value;
  const filtroTrim = document.getElementById('fac-filtro-trim').value;
  const filtroEst = document.getElementById('fac-filtro-estado').value;

  // Poblar selector de a√±os
  const anyos = [...new Set(facturas.map(f => getAnyo(f.fecha)))].sort((a,b)=>b-a);
  const selAnyo = document.getElementById('fac-filtro-anyo');
  const currentVal = selAnyo.value;
  selAnyo.innerHTML = '<option value="todos">Todos</option>' + anyos.map(a=>`<option value="${a}">${a}</option>`).join('');
  selAnyo.value = currentVal;

  let lista = [...facturas];
  if (filtroAnyo !== 'todos') lista = lista.filter(f => getAnyo(f.fecha) === parseInt(filtroAnyo));
  if (filtroTrim !== 'todos') lista = lista.filter(f => getTrimestre(f.fecha) === parseInt(filtroTrim));
  if (filtroEst !== 'todos') lista = lista.filter(f => f.estado === filtroEst);
  lista.sort((a,b) => b.fecha.localeCompare(a.fecha));

  const tbody = document.getElementById('tabla-facturas');
  tbody.innerHTML = lista.map(f => `
    <tr>
      <td>${f.num || '‚Äì'}</td>
      <td>${formatFecha(f.fecha)}</td>
      <td>${esc(f.cliente)}</td>
      <td class="green">${fmt(f.base)} ‚Ç¨</td>
      <td>${f.pais !== 'ES' ? '<span class="tag tag-blue">'+f.pais+'</span>' : fmt(f.iva)+' ‚Ç¨'}</td>
      <td>${f.irpf > 0 ? fmt(f.irpf)+' ‚Ç¨' : '‚Äì'}</td>
      <td style="font-weight:600">${fmt(f.total)} ‚Ç¨</td>
      <td><span class="tag ${f.estado==='cobrada'?'tag-green':f.estado==='anulada'?'tag-red':'tag-yellow'}">${f.estado}</span></td>
      <td><button class="btn btn-ghost btn-sm" onclick="eliminarFactura(${f.id})">üóë</button></td>
    </tr>`).join('') || '<tr><td colspan="9" style="color:var(--text2);text-align:center">Sin facturas en este periodo</td></tr>';

  const totalBase = lista.filter(f=>f.estado!=='anulada').reduce((s,f)=>s+parseFloat(f.base||0),0);
  const totalIva = lista.filter(f=>f.estado!=='anulada' && f.pais==='ES').reduce((s,f)=>s+parseFloat(f.iva||0),0);
  document.getElementById('fac-totales').innerHTML = `Base total: <strong>${fmt(totalBase)} ‚Ç¨</strong> ¬∑ IVA repercutido: <strong>${fmt(totalIva)} ‚Ç¨</strong>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GASTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcularGastoBase() {
  const total = parseFloat(document.getElementById('gas-total').value) || 0;
  const ivaPct = parseFloat(document.getElementById('gas-iva-pct').value) || 0;
  const base = round2(total / (1 + ivaPct/100));
  document.getElementById('gas-base').value = base.toFixed(2);
}

function mostrarAvisoCuotaAutonomos() {
  const cat = document.getElementById('gas-categoria').value;
  document.getElementById('gas-aviso-cuota').style.display = cat === 'cuota_autonomos' ? 'block' : 'none';
}

function guardarGasto() {
  const fecha = document.getElementById('gas-fecha').value;
  const proveedor = document.getElementById('gas-proveedor').value.trim();
  const total = parseFloat(document.getElementById('gas-total').value);
  if (!fecha || !proveedor || isNaN(total) || total < 0) {
    alert('Por favor rellena fecha, proveedor e importe.'); return;
  }
  const ivaPct = parseFloat(document.getElementById('gas-iva-pct').value) || 0;
  const base = round2(total / (1 + ivaPct/100));
  const iva = round2(total - base);
  const deduciblePct = parseInt(document.getElementById('gas-deducible').value);
  const baseDeducible = round2(base * deduciblePct / 100);
  const ivaSoportado = round2(iva * deduciblePct / 100);

  gastos.push({
    id: Date.now(), fecha, proveedor,
    categoria: document.getElementById('gas-categoria').value,
    total, ivaPct, base, iva, deduciblePct, baseDeducible, ivaSoportado,
    nfactura: document.getElementById('gas-nfactura').value.trim(),
    notas: document.getElementById('gas-notas').value.trim()
  });
  guardarEnStorage();
  limpiarFormGasto();
  renderGastos();
  renderDashboard();
  alert('‚úÖ Gasto guardado.');
}

function limpiarFormGasto() {
  ['gas-fecha','gas-proveedor','gas-total','gas-nfactura','gas-notas'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('gas-base').value = '';
  document.getElementById('gas-iva-pct').value = '21';
  document.getElementById('gas-deducible').value = '100';
  document.getElementById('gas-fecha').value = hoyISO();
  document.getElementById('gas-aviso-cuota').style.display = 'none';
}

function eliminarGasto(id) {
  if (!confirm('¬øEliminar este gasto?')) return;
  gastos = gastos.filter(g => g.id !== id);
  guardarEnStorage(); renderGastos(); renderDashboard();
}

function renderGastos() {
  const filtroAnyo = document.getElementById('gas-filtro-anyo').value;
  const filtroTrim = document.getElementById('gas-filtro-trim').value;
  const filtroCat = document.getElementById('gas-filtro-cat').value;

  const anyos = [...new Set(gastos.map(g => getAnyo(g.fecha)))].sort((a,b)=>b-a);
  const selA = document.getElementById('gas-filtro-anyo');
  const cv = selA.value; selA.innerHTML = '<option value="todos">Todos</option>' + anyos.map(a=>`<option value="${a}">${a}</option>`).join(''); selA.value = cv;

  const cats = [...new Set(gastos.map(g=>g.categoria))].sort();
  const selC = document.getElementById('gas-filtro-cat');
  const cvc = selC.value; selC.innerHTML = '<option value="todos">Todas</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join(''); selC.value = cvc;

  let lista = [...gastos];
  if (filtroAnyo !== 'todos') lista = lista.filter(g => getAnyo(g.fecha) === parseInt(filtroAnyo));
  if (filtroTrim !== 'todos') lista = lista.filter(g => getTrimestre(g.fecha) === parseInt(filtroTrim));
  if (filtroCat !== 'todos') lista = lista.filter(g => g.categoria === filtroCat);
  lista.sort((a,b) => b.fecha.localeCompare(a.fecha));

  const tbody = document.getElementById('tabla-gastos');
  tbody.innerHTML = lista.map(g => `
    <tr>
      <td>${formatFecha(g.fecha)}</td>
      <td>${esc(g.proveedor)}</td>
      <td>${esc(g.categoria)}</td>
      <td>${fmt(g.base)} ‚Ç¨</td>
      <td>${fmt(g.iva)} ‚Ç¨</td>
      <td>${fmt(g.total)} ‚Ç¨</td>
      <td>${g.deduciblePct}% ‚Üí ${fmt(g.baseDeducible)} ‚Ç¨</td>
      <td><button class="btn btn-ghost btn-sm" onclick="eliminarGasto(${g.id})">üóë</button></td>
    </tr>`).join('') || '<tr><td colspan="8" style="color:var(--text2);text-align:center">Sin gastos en este periodo</td></tr>';

  const totalDeducible = lista.reduce((s,g)=>s+parseFloat(g.baseDeducible||0),0);
  const totalIva = lista.reduce((s,g)=>s+parseFloat(g.ivaSoportado||0),0);
  document.getElementById('gas-totales').innerHTML = `Total deducible (base): <strong>${fmt(totalDeducible)} ‚Ç¨</strong> ¬∑ IVA soportado deducible: <strong>${fmt(totalIva)} ‚Ç¨</strong>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// F3: MODELO 303 ‚Äî CON CASILLAS REALES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcularModelo303() {
  const anyo = parseInt(document.getElementById('m303-anyo').value);
  const trim = parseInt(document.getElementById('m303-trim').value);

  const facsT = facturas.filter(f => f.estado !== 'anulada' && getAnyo(f.fecha) === anyo && getTrimestre(f.fecha) === trim);
  const gasT = gastos.filter(g => getAnyo(g.fecha) === anyo && getTrimestre(g.fecha) === trim);

  // IVA devengado por tipo
  const facES = facsT.filter(f => f.pais === 'ES');
  const facEU = facsT.filter(f => f.pais === 'EU'); // inversi√≥n sujeto pasivo

  const base21 = facES.filter(f=>f.ivaPct===21).reduce((s,f)=>s+parseFloat(f.base||0),0);
  const iva21  = round2(base21 * 0.21);
  const base10 = facES.filter(f=>f.ivaPct===10).reduce((s,f)=>s+parseFloat(f.base||0),0);
  const iva10  = round2(base10 * 0.10);
  const base4  = facES.filter(f=>f.ivaPct===4).reduce((s,f)=>s+parseFloat(f.base||0),0);
  const iva4   = round2(base4 * 0.04);
  const baseEU = facEU.reduce((s,f)=>s+parseFloat(f.base||0),0);
  const ivaEU  = round2(baseEU * 0.21); // IVA que deber√≠a haberse repercutido en inversi√≥n SP
  const totalDevengado = round2(iva21 + iva10 + iva4 + ivaEU);

  // IVA soportado deducible
  const ivaDeducible = gasT.reduce((s,g)=>s+parseFloat(g.ivaSoportado||0),0);

  const resultado = round2(totalDevengado - ivaDeducible);

  // Alertas intracomunitario
  let alertas = '';
  if (facEU.length > 0) {
    alertas += `<div class="alert alert-info">‚ÑπÔ∏è Tienes ${facEU.length} factura(s) a clientes UE (inversi√≥n sujeto pasivo). Se incluyen en casillas 10-11 del Mod. 303 y debes presentar tambi√©n el <strong>Mod. 349</strong>.</div>`;
  }
  document.getElementById('m303-alertas').innerHTML = alertas;

  // Render casillas
  document.getElementById('m303-devengado').innerHTML = `
    <div class="casilla-row"><span class="casilla-num">01</span><span>Base imponible tipo general (21%) ‚Äî Operaciones interiores</span><span class="casilla-val">${fmt(base21)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">03</span><span>Cuota (21%)</span><span class="casilla-val green">${fmt(iva21)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">05</span><span>Base imponible tipo reducido (10%)</span><span class="casilla-val">${fmt(base10)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">07</span><span>Cuota (10%)</span><span class="casilla-val green">${fmt(iva10)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">09</span><span>Base imponible tipo superreducido (4%)</span><span class="casilla-val">${fmt(base4)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">11</span><span>Cuota (4%)</span><span class="casilla-val green">${fmt(iva4)} ‚Ç¨</span></div>
    ${baseEU > 0 ? `
    <div class="casilla-row"><span class="casilla-num">10</span><span>Base imponible ‚Äî adq. intracomunitarias / inv. sujeto pasivo</span><span class="casilla-val">${fmt(baseEU)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">11</span><span>Cuota ‚Äî adq. intracomunitarias</span><span class="casilla-val green">${fmt(ivaEU)} ‚Ç¨</span></div>
    ` : ''}
    <div class="casilla-row total-row"><span class="casilla-num">27</span><span><strong>Total IVA devengado</strong></span><span class="casilla-val">${fmt(totalDevengado)} ‚Ç¨</span></div>`;

  document.getElementById('m303-deducible').innerHTML = `
    <div class="casilla-row"><span class="casilla-num">28</span><span>IVA soportado deducible en operaciones interiores corrientes</span><span class="casilla-val red">${fmt(ivaDeducible)} ‚Ç¨</span></div>
    ${baseEU > 0 ? `<div class="casilla-row"><span class="casilla-num">32</span><span>IVA deducible en adquisiciones intracomunitarias</span><span class="casilla-val red">${fmt(ivaEU)} ‚Ç¨</span></div>` : ''}
    <div class="casilla-row total-row"><span class="casilla-num">45</span><span><strong>Total IVA deducible</strong></span><span class="casilla-val">${fmt(baseEU > 0 ? ivaDeducible + ivaEU : ivaDeducible)} ‚Ç¨</span></div>`;

  const totalDeducible2 = baseEU > 0 ? round2(ivaDeducible + ivaEU) : ivaDeducible;
  const resultadoFinal = round2(totalDevengado - totalDeducible2);

  document.getElementById('m303-resultado').innerHTML = `
    <div class="casilla-row"><span class="casilla-num">46</span><span>Resultado (Cas. 27 ‚Äì Cas. 45)</span><span class="casilla-val ${resultadoFinal>=0?'yellow':'green'}">${fmt(resultadoFinal)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">65</span><span>% de tributaci√≥n a la Administraci√≥n del Estado</span><span class="casilla-val">100 %</span></div>
    <div class="casilla-row total-row"><span class="casilla-num">71</span><span><strong>${resultadoFinal >= 0 ? '‚ö†Ô∏è A ingresar' : '‚úÖ A compensar o devolver'}</strong></span><span class="casilla-val ${resultadoFinal>=0?'red':'green'}">${fmt(Math.abs(resultadoFinal))} ‚Ç¨</span></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// F4: MODELO 130 ‚Äî ACUMULADO Y CASILLAS REALES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcularModelo130() {
  const anyo = parseInt(document.getElementById('m130-anyo').value);
  const trim = parseInt(document.getElementById('m130-trim').value);

  // Acumulado desde enero hasta fin del trimestre (como exige Hacienda)
  const facAcum = facturas.filter(f => f.estado !== 'anulada' && getAnyo(f.fecha) === anyo && getTrimestre(f.fecha) <= trim);
  const gasAcum = gastos.filter(g => getAnyo(g.fecha) === anyo && getTrimestre(g.fecha) <= trim);

  const ingresosAcum = facAcum.reduce((s,f) => s + parseFloat(f.base||0), 0);
  const gastosAcum   = gasAcum.reduce((s,g) => s + parseFloat(g.baseDeducible||g.base||0), 0);
  const rendimientoNeto = round2(ingresosAcum - gastosAcum);
  const cuota20 = round2(Math.max(0, rendimientoNeto) * 0.20);

  // Retenciones acumuladas del a√±o
  const retencionesAcum = facAcum.reduce((s,f) => s + parseFloat(f.irpf||0), 0);

  // Pagos fraccionados anteriores del mismo a√±o (suma de Mod.130 ya presentados)
  const pagosAnteriores = Array.from({length: trim-1}, (_,i) => {
    const clave = `M130_${anyo}_T${i+1}`;
    return parseFloat(estadosModelos[clave + '_importe'] || 0);
  }).reduce((s,v)=>s+v, 0);

  const resultado = round2(cuota20 - retencionesAcum - pagosAnteriores);
  const aPagar = Math.max(0, resultado);

  // Verificar exenci√≥n (>70% con retenci√≥n)
  const ingresosTotales = ingresosAcum;
  const pctConRetencion = ingresosTotales > 0
    ? facAcum.filter(f=>f.irpfPct > 0).reduce((s,f)=>s+parseFloat(f.base||0),0) / ingresosTotales * 100
    : 0;

  let alertas = '';
  if (pctConRetencion >= 70) {
    alertas += `<div class="alert alert-success">‚úÖ <strong>Exento de presentar el Mod. 130 este trimestre:</strong> El ${pctConRetencion.toFixed(1)}% de tus ingresos acumulados ya llevan retenci√≥n de IRPF (supera el 70% requerido). Puedes no presentarlo, aunque si quieres hacerlo voluntariamente es posible.</div>`;
  } else if (pctConRetencion > 0) {
    alertas += `<div class="alert alert-warning">‚ÑπÔ∏è El ${pctConRetencion.toFixed(1)}% de tus ingresos llevan retenci√≥n. Para quedar exento necesitas llegar al 70%.</div>`;
  }
  document.getElementById('m130-alertas').innerHTML = alertas;

  document.getElementById('m130-casillas').innerHTML = `
    <div class="casilla-row"><span class="casilla-num">01</span><span>Ingresos acumulados desde el 1 de enero hasta fin de ${['','enero','junio','septiembre','diciembre'][trim]} (excl. IVA)</span><span class="casilla-val green">${fmt(ingresosAcum)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">02</span><span>Gastos deducibles acumulados del mismo periodo</span><span class="casilla-val red">${fmt(gastosAcum)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">03</span><span>Rendimiento neto acumulado (01 ‚Äì 02)</span><span class="casilla-val ${rendimientoNeto>=0?'':'red'}">${fmt(rendimientoNeto)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">04</span><span>20% del rendimiento neto (base del pago fraccionado)</span><span class="casilla-val yellow">${fmt(cuota20)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">05</span><span>Retenciones e ingresos a cuenta soportados acumulados en el a√±o</span><span class="casilla-val red">${fmt(retencionesAcum)} ‚Ç¨</span></div>
    <div class="casilla-row"><span class="casilla-num">07</span><span>Pagos fraccionados ingresados por el Mod. 130 en trimestres anteriores del a√±o</span><span class="casilla-val red">${fmt(pagosAnteriores)} ‚Ç¨</span></div>
    <div class="casilla-row total-row"><span class="casilla-num">14</span><span><strong>${aPagar > 0 ? '‚ö†Ô∏è A ingresar' : '‚úÖ Resultado negativo / cero (no se ingresa)'}</strong></span><span class="casilla-val ${aPagar>0?'red':'green'}">${fmt(aPagar)} ‚Ç¨</span></div>
    ${aPagar > 0 ? `<p class="nota" style="margin-top:.8rem">Guarda el importe ingresado (${fmt(aPagar)} ‚Ç¨) para que se descuente autom√°ticamente en trimestres posteriores.</p>` : ''}`;

  // Guardar importe para descontar en trimestres siguientes
  if (estadosModelos[`M130_${anyo}_T${trim}`] === 'presentado') {
    estadosModelos[`M130_${anyo}_T${trim}_importe`] = aPagar;
    guardarEnStorage();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODELO 349 ‚Äî OPERACIONES INTRACOMUNITARIAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function calcularModelo349() {
  const anyo = parseInt(document.getElementById('m349-anyo').value);
  const trim = parseInt(document.getElementById('m349-trim').value);
  const facEU = facturas.filter(f => f.pais === 'EU' && getAnyo(f.fecha) === anyo && getTrimestre(f.fecha) === trim && f.estado !== 'anulada');

  if (facEU.length === 0) {
    document.getElementById('m349-contenido').innerHTML = '<div class="alert alert-success">‚úÖ No tienes operaciones intracomunitarias este trimestre. <strong>No necesitas presentar el Mod. 349.</strong></div>';
    return;
  }

  // Agrupar por cliente / NIF intracomunitario
  const grupos = {};
  facEU.forEach(f => {
    const key = f.nifCliente || f.cliente;
    if (!grupos[key]) grupos[key] = { cliente: f.cliente, nif: f.nifCliente, base: 0, facturas: 0 };
    grupos[key].base += parseFloat(f.base||0);
    grupos[key].facturas++;
  });

  const total = Object.values(grupos).reduce((s,g)=>s+g.base,0);

  document.getElementById('m349-contenido').innerHTML = `
    <div class="alert alert-warning">üìã Tienes operaciones intracomunitarias este trimestre. <strong>Debes presentar el Mod. 349.</strong></div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>NIF intracomunitario</th><th>Nombre / raz√≥n social</th><th>Clave operaci√≥n</th><th>Base (‚Ç¨)</th></tr></thead>
        <tbody>
          ${Object.values(grupos).map(g=>`
            <tr>
              <td>${esc(g.nif || 'Sin NIF')}</td>
              <td>${esc(g.cliente)}</td>
              <td>S ‚Äî Prestaciones de servicios</td>
              <td>${fmt(g.base)} ‚Ç¨</td>
            </tr>`).join('')}
          <tr style="font-weight:700;background:var(--surface2)"><td colspan="3">TOTAL</td><td>${fmt(total)} ‚Ç¨</td></tr>
        </tbody>
      </table>
    </div>
    <p class="nota" style="margin-top:.8rem">Presenta el Mod. 349 en la sede electr√≥nica de la AEAT. El plazo coincide con el del Mod. 303.</p>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// F5: CUOTA AUT√ìNOMOS ‚Äî TRAMOS INGRESOS REALES 2025-2026
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TRAMOS_AUTONOMOS_2026 = [
  { num:1,  desde:0,      hasta:670,    cuotaMin:200,  cuotaMax:260,  label:'‚â§ 670 ‚Ç¨/mes' },
  { num:2,  desde:670,    hasta:900,    cuotaMin:250,  cuotaMax:270,  label:'670 ‚Äì 900 ‚Ç¨/mes' },
  { num:3,  desde:900,    hasta:1166.7, cuotaMin:267,  cuotaMax:294,  label:'900 ‚Äì 1.166 ‚Ç¨/mes' },
  { num:4,  desde:1166.7, hasta:1300,   cuotaMin:291,  cuotaMax:340,  label:'1.166 ‚Äì 1.300 ‚Ç¨/mes' },
  { num:5,  desde:1300,   hasta:1500,   cuotaMin:294,  cuotaMax:350,  label:'1.300 ‚Äì 1.500 ‚Ç¨/mes' },
  { num:6,  desde:1500,   hasta:1700,   cuotaMin:294,  cuotaMax:370,  label:'1.500 ‚Äì 1.700 ‚Ç¨/mes' },
  { num:7,  desde:1700,   hasta:1850,   cuotaMin:310,  cuotaMax:390,  label:'1.700 ‚Äì 1.850 ‚Ç¨/mes' },
  { num:8,  desde:1850,   hasta:2030,   cuotaMin:315,  cuotaMax:420,  label:'1.850 ‚Äì 2.030 ‚Ç¨/mes' },
  { num:9,  desde:2030,   hasta:2330,   cuotaMin:320,  cuotaMax:445,  label:'2.030 ‚Äì 2.330 ‚Ç¨/mes' },
  { num:10, desde:2330,   hasta:2760,   cuotaMin:330,  cuotaMax:505,  label:'2.330 ‚Äì 2.760 ‚Ç¨/mes' },
  { num:11, desde:2760,   hasta:3190,   cuotaMin:340,  cuotaMax:535,  label:'2.760 ‚Äì 3.190 ‚Ç¨/mes' },
  { num:12, desde:3190,   hasta:3620,   cuotaMin:350,  cuotaMax:570,  label:'3.190 ‚Äì 3.620 ‚Ç¨/mes' },
  { num:13, desde:3620,   hasta:4050,   cuotaMin:360,  cuotaMax:630,  label:'3.620 ‚Äì 4.050 ‚Ç¨/mes' },
  { num:14, desde:4050,   hasta:6000,   cuotaMin:370,  cuotaMax:720,  label:'4.050 ‚Äì 6.000 ‚Ç¨/mes' },
  { num:15, desde:6000,   hasta:Infinity,cuotaMin:390, cuotaMax:1267, label:'> 6.000 ‚Ç¨/mes' },
];

function renderTramosAutonomos() {
  document.getElementById('tramo-grid').innerHTML = TRAMOS_AUTONOMOS_2026.map(t => `
    <div class="tramo-card" id="tramo-${t.num}">
      <div class="tramo-titulo">Tramo ${t.num}: ${t.label}</div>
      <div class="tramo-cuota">M√≠n. ${t.cuotaMin} ‚Ç¨/mes ¬∑ M√°x. ${t.cuotaMax} ‚Ç¨/mes</div>
    </div>`).join('');
}

function calcularCuotaAutonomos() {
  const rendAnual = parseFloat(document.getElementById('aut-rendimiento').value) || 0;
  const rendMensual = rendAnual / 12;

  const tramo = TRAMOS_AUTONOMOS_2026.find(t => rendMensual >= t.desde && rendMensual < t.hasta) || TRAMOS_AUTONOMOS_2026[0];

  document.getElementById('aut-tramo-activo').innerHTML = `
    <div class="alert alert-info">
      <div>
        <strong>Tu tramo estimado: Tramo ${tramo.num}</strong> (${tramo.label})<br>
        Cuota m√≠nima: <strong>${tramo.cuotaMin} ‚Ç¨/mes</strong> ¬∑ Cuota m√°xima: ${tramo.cuotaMax} ‚Ç¨/mes<br>
        Cuota anual m√≠nima estimada: <strong>${tramo.cuotaMin * 12} ‚Ç¨</strong>
      </div>
    </div>`;

  let alertas = '';
  if (rendAnual < 6000) {
    alertas += `<div class="alert alert-warning">üìâ Tus ingresos son bajos. Recuerda que puedes solicitar cambio de tramo a la TGSS hasta 6 veces al a√±o si tus ingresos var√≠an. Hazlo antes de que empiece el mes en que cambia tu situaci√≥n.</div>`;
  }
  if (rendAnual < 4800) {
    alertas += `<div class="alert alert-info">‚ÑπÔ∏è Con ingresos inferiores a 4.800 ‚Ç¨/a√±o podr√≠as estar en la tarifa plana de inicio de actividad (30 ‚Ç¨/mes durante 12 meses, prorrogable a 24) si te diste de alta recientemente. Consulta con la TGSS.</div>`;
  }
  document.getElementById('aut-alertas').innerHTML = alertas;

  // Destacar tramo en la tabla
  document.querySelectorAll('.tramo-card').forEach(c => c.classList.remove('activo'));
  const el = document.getElementById('tramo-' + tramo.num);
  if (el) { el.classList.add('activo'); el.scrollIntoView({behavior:'smooth',block:'nearest'}); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARCAR PRESENTADO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function marcarPresentado(modelo) {
  const anyo = parseInt(document.getElementById(`m${modelo}-anyo`).value);
  const trim  = parseInt(document.getElementById(`m${modelo}-trim`).value);
  const clave = `M${modelo}_${anyo}_T${trim}`;
  estadosModelos[clave] = 'presentado';

  // Si es 130, guardar importe
  if (modelo === '130') {
    const casEl = document.getElementById('m130-casillas');
    // el importe ya se guarda en calcularModelo130 al recalcular
    calcularModelo130();
    estadosModelos[`${clave}_importe`] = parseFloat(
      document.getElementById('m130-casillas').querySelector('.total-row .casilla-val')?.textContent?.replace(/[^0-9,.]/g,'').replace(',','.') || 0
    );
  }
  guardarEnStorage();
  renderDashboard();
  alert(`‚úÖ Modelo ${modelo} ‚Äî ${trim}T ${anyo} marcado como presentado.`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT / IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function exportarDatos() {
  const data = { facturas, gastos, estadosModelos, exportadoEl: new Date().toISOString(), version: '2.0' };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `gestion-fiscal-backup-${hoyISO()}.json`;
  a.click(); URL.revokeObjectURL(url);
}

function importarDatos(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!confirm(`¬øImportar ${(data.facturas||[]).length} facturas y ${(data.gastos||[]).length} gastos? Esto reemplazar√° los datos actuales.`)) return;
      facturas = data.facturas || [];
      gastos = data.gastos || [];
      estadosModelos = data.estadosModelos || {};
      guardarEnStorage();
      renderDashboard(); renderFacturas(); renderGastos();
      alert('‚úÖ Datos importados correctamente.');
    } catch(err) { alert('Error al importar: ' + err.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function borrarTodosLosDatos() {
  if (!confirm('‚ö†Ô∏è ¬øBorrar TODOS los datos? Esta acci√≥n no se puede deshacer.')) return;
  if (!confirm('√öltima confirmaci√≥n: ¬øseguro que quieres borrar todo?')) return;
  facturas = []; gastos = []; estadosModelos = {};
  localStorage.removeItem('facturas_v2');
  localStorage.removeItem('gastos_v2');
  localStorage.removeItem('estadosModelos_v2');
  renderDashboard(); renderFacturas(); renderGastos();
  alert('üóë Todos los datos han sido eliminados.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function fmt(n) { return parseFloat(n||0).toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function round2(n) { return Math.round(n * 100) / 100; }
function hoyISO() { return new Date().toISOString().split('T')[0]; }
function getAnyo(fecha) { return fecha ? parseInt(fecha.split('-')[0]) : 0; }
function getTrimestre(fecha) { if (!fecha) return 0; const m = parseInt(fecha.split('-')[1]); return Math.ceil(m/3); }
function formatFecha(f) { if (!f) return '‚Äì'; const [y,m,d] = f.split('-'); return `${d}/${m}/${y}`; }
function esc(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function poblarFiltrosAnyo() {
  const anyos = [2024, 2025, 2026, 2027];
  ['m303-anyo','m130-anyo','m349-anyo'].forEach(id => {
    const el = document.getElementById(id);
    const cur = new Date().getFullYear();
    el.innerHTML = anyos.map(a => `<option value="${a}" ${a===cur?'selected':''}>${a}</option>`).join('');
  });
  // Auto-seleccionar trimestre actual
  const trimActual = getTrimestre(hoyISO());
  ['m303-trim','m130-trim','m349-trim'].forEach(id => {
    document.getElementById(id).value = trimActual;
  });
}

function poblarSelectorAnyo() {
  const anyos = [...new Set([...facturas.map(f=>getAnyo(f.fecha)), ...gastos.map(g=>getAnyo(g.fecha)), new Date().getFullYear()])].sort((a,b)=>b-a);
  ['fac-filtro-anyo','gas-filtro-anyo'].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = '<option value="todos">Todos</option>' + anyos.map(a=>`<option value="${a}">${a}</option>`).join('');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.addEventListener('DOMContentLoaded', () => {
  cargarDatos();
  verificarConfiguracion();
  poblarFiltrosAnyo();
  poblarSelectorAnyo();
  limpiarFormFactura();
  limpiarFormGasto();
  renderDashboard();
  renderFacturas();
  renderGastos();
  renderTramosAutonomos();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Fiscal - Javier Gómez</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: #F5F5F7;
            min-height: 100vh;
            padding: 20px;
            color: #1D1D1F;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 60px;
        }
        
        .header {
            background: white;
            padding: 32px 40px;
            border-radius: 18px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
            border: 0.5px solid rgba(0,0,0,0.04);
        }
        
        .header h1 {
            font-size: 2.2em;
            font-weight: 600;
            color: #1D1D1F;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .header-subtitle {
            color: #86868B;
            font-size: 1.05em;
            margin-top: 6px;
        }
        
        .header-info {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            flex-wrap: wrap;
            font-size: 0.95em;
        }
        
        .header-info span {
            color: #515154;
            background: #F5F5F7;
            padding: 6px 14px;
            border-radius: 8px;
        }
        
        .alert-vencimiento {
            background: #007AFF;
            color: white;
            padding: 20px 32px;
            border-radius: 16px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.2);
            font-size: 1.05em;
        }
        
        .alert-urgente {
            background: #FF3B30;
        }
        
        .alert-preparar {
            background: #FF9500;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 6px;
            background: rgba(255,255,255,0.8);
            border-radius: 14px;
            backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 0.5px solid rgba(0,0,0,0.04);
        }
        
        .tab {
            background: transparent;
            color: #515154;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab:hover {
            background: rgba(0,0,0,0.04);
        }
        
        .tab.active {
            background: #007AFF;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }
        
        .content {
            background: white;
            border-radius: 18px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
            min-height: 500px;
            border: 0.5px solid rgba(0,0,0,0.04);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: linear-gradient(180deg, #FFFFFF 0%, #F5F5F7 100%);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 0.5px solid rgba(0,0,0,0.06);
        }
        
        .card h3 {
            font-size: 0.9em;
            color: #86868B;
            margin-bottom: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card .value {
            font-size: 2.4em;
            font-weight: 600;
            color: #1D1D1F;
            letter-spacing: -1px;
        }
        
        .card.primary {
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            color: white;
        }
        
        .card.primary h3 {
            color: rgba(255,255,255,0.8);
        }
        
        .card.primary .value {
            color: white;
        }
        
        .card.success {
            background: linear-gradient(135deg, #34C759 0%, #30B350 100%);
            color: white;
        }
        
        .card.success h3 {
            color: rgba(255,255,255,0.8);
        }
        
        .card.success .value {
            color: white;
        }
        
        .card.warning {
            background: linear-gradient(135deg, #FF9500 0%, #FF8000 100%);
            color: white;
        }
        
        .card.warning h3 {
            color: rgba(255,255,255,0.8);
        }
        
        .card.warning .value {
            color: white;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #1D1D1F;
            font-size: 0.95em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            border: 1px solid #D2D2D7;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            color: #1D1D1F;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        
        .form-group input::placeholder {
            color: #C7C7CC;
        }
        
        .form-group input:read-only,
        .form-group input[readonly] {
            background: #F5F5F7;
            cursor: not-allowed;
        }
        
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 28px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 4px rgba(0, 122, 255, 0.3);
        }
        
        .btn:hover {
            background: #0051D5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #34C759;
        }
        
        .btn-secondary:hover {
            background: #30B350;
        }
        
        .btn-warning {
            background: #FF9500;
            color: white;
        }
        
        .btn-warning:hover {
            background: #FF8000;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 24px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 0.5px solid rgba(0,0,0,0.06);
        }
        
        thead {
            background: #F5F5F7;
        }
        
        th, td {
            padding: 14px 16px;
            text-align: left;
            font-size: 0.95em;
        }
        
        th {
            font-weight: 600;
            color: #1D1D1F;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 0.5px solid #F5F5F7;
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: #FAFAFA;
        }
        
        tbody tr:last-child {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .badge-amazon { background: #FFEDD5; color: #C2410C; }
        .badge-upwork { background: #D1FAE5; color: #065F46; }
        .badge-stripe { background: #E0E7FF; color: #3730A3; }
        .badge-otros { background: #F5F5F7; color: #515154; }
        
        .info-box {
            background: #E3F2FD;
            border-left: 3px solid #007AFF;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 10px;
            color: #1D1D1F;
        }
        
        .info-box strong {
            color: #007AFF;
        }
        
        .warning-box {
            background: #FFF4E5;
            border-left: 3px solid #FF9500;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 10px;
            color: #1D1D1F;
        }
        
        .warning-box strong {
            color: #FF9500;
        }
        
        .modelo-box {
            background: #FAFAFA;
            border: 1px solid #E5E5E7;
            border-radius: 14px;
            padding: 24px;
            margin: 24px 0;
        }
        
        .modelo-title {
            font-size: 1.5em;
            color: #1D1D1F;
            margin-bottom: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .row-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 0.5px solid #E5E5E7;
            color: #515154;
        }
        
        .row-item:last-child {
            border-bottom: none;
        }
        
        .row-item.total {
            background: #007AFF;
            color: white;
            font-weight: 600;
            font-size: 1.3em;
            margin-top: 16px;
            padding: 16px 20px;
            border-radius: 10px;
            border-bottom: none;
        }
        
        .acciones {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .countdown-box {
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin: 24px 0;
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
        }
        
        .countdown-days {
            font-size: 5em;
            font-weight: 700;
            margin: 16px 0;
            letter-spacing: -2px;
        }
        
        .countdown-label {
            font-size: 1.2em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
        }
        
        .guia-presentacion {
            background: white;
            border: 1px solid #E5E5E7;
            border-radius: 14px;
            padding: 24px;
            margin: 24px 0;
        }
        
        .guia-presentacion h3 {
            color: #007AFF;
            margin-bottom: 16px;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .guia-presentacion ol {
            margin-left: 24px;
            line-height: 1.8;
        }
        
        .guia-presentacion li {
            margin: 12px 0;
            color: #515154;
        }
        
        .checkbox-control {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #FAFAFA;
            border-radius: 10px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .checkbox-control:hover {
            background: #F5F5F7;
        }
        
        .checkbox-control input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #007AFF;
        }
        
        .estado-presentado {
            background: #D1FAE5;
            color: #065F46;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .estado-pendiente {
            background: #FFEDD5;
            color: #C2410C;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .backup-section {
            background: #FAFAFA;
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
            border: 1px solid #E5E5E7;
        }
        
        .backup-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #007AFF;
            letter-spacing: -1px;
        }
        
        .stat-label {
            color: #86868B;
            font-size: 0.9em;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .factura-preview {
            background: white;
            border: 1px solid #E5E5E7;
            border-radius: 14px;
            padding: 40px;
            margin: 24px 0;
        }
        
        .factura-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 24px;
            border-bottom: 2px solid #F5F5F7;
            margin-bottom: 32px;
        }
        
        .factura-title {
            font-size: 2.5em;
            font-weight: 700;
            color: #1D1D1F;
            letter-spacing: -1px;
        }
        
        .factura-numero {
            text-align: right;
            color: #515154;
        }
        
        .datos-section {
            margin: 24px 0;
        }
        
        .datos-section h3 {
            color: #007AFF;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .datos-section p {
            margin: 6px 0;
            color: #515154;
            line-height: 1.6;
        }
        
        h2 {
            color: #1D1D1F;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }
        
        h3 {
            color: #1D1D1F;
            font-size: 1.3em;
            font-weight: 600;
            margin: 24px 0 16px;
        }
        
        @media print {
            body { background: white; }
            .header, .tabs, .acciones, .btn { display: none !important; }
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .grid-3, .grid-2 { grid-template-columns: 1fr; }
            .content { padding: 24px; }
            .countdown-days { font-size: 3.5em; }
            .tabs { overflow-x: scroll; }
        }
        
        .success-pulse {
            animation: successPulse 0.5s ease;
        }
        
        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        /* Scrollbar personalizado estilo macOS */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #D2D2D7;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #C7C7CC;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Gestión Fiscal</h1>
            <p class="header-subtitle">Javier Gómez Fernández</p>
            <div class="header-info">
                <span>NIF: 28838594-K</span>
                <span>Alta: 10/11/2025</span>
                <span>774-2 Traductores e intérpretes</span>
                <span>Retención IRPF: 7%</span>
            </div>
        </div>
        
        <div id="alertaVencimiento"></div>
        
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="cambiarTab('facturas')">Facturas</button>
            <button class="tab" onclick="cambiarTab('gastos')">Gastos</button>
            <button class="tab" onclick="cambiarTab('modelo303')">Modelo 303</button>
            <button class="tab" onclick="cambiarTab('modelo130')">Modelo 130</button>
            <button class="tab" onclick="cambiarTab('resumen')">Resumen Anual</button>
            <button class="tab" onclick="cambiarTab('utilidades')">Utilidades</button>
        </div>
        
        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="tab-content active">
                <div id="proximoVencimientoBox"></div>
                
                <h2>Resumen del Trimestre Actual</h2>
                
                <div class="grid-3">
                    <div class="card primary">
                        <h3>Ingresos Totales</h3>
                        <div class="value" id="dashIngresos">0,00 €</div>
                    </div>
                    <div class="card warning">
                        <h3>Gastos Totales</h3>
                        <div class="value" id="dashGastos">0,00 €</div>
                    </div>
                    <div class="card success">
                        <h3>Beneficio Neto</h3>
                        <div class="value" id="dashBeneficio">0,00 €</div>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="card">
                        <h3>IVA Situación</h3>
                        <div class="value" id="dashIva">0,00 €</div>
                        <small style="color: #86868B;">A ingresar (+) / A devolver (-)</small>
                    </div>
                    <div class="card">
                        <h3>Retenciones IRPF</h3>
                        <div class="value" id="dashRetenciones">0,00 €</div>
                        <small style="color: #86868B;">Ya pagadas a Hacienda</small>
                    </div>
                </div>
                
                <h3>Ingresos por Fuente</h3>
                <div class="grid-3">
                    <div class="card" style="background: linear-gradient(135deg, #FF9500 0%, #FF8000 100%); color: white;">
                        <h3 style="color: rgba(255,255,255,0.8);">Amazon KDP</h3>
                        <div class="value" style="color: white;" id="dashAmazon">0,00 €</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #34C759 0%, #30B350 100%); color: white;">
                        <h3 style="color: rgba(255,255,255,0.8);">UpWork</h3>
                        <div class="value" style="color: white;" id="dashUpwork">0,00 €</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #5E5CE6 0%, #4C4ADB 100%); color: white;">
                        <h3 style="color: rgba(255,255,255,0.8);">Stripe</h3>
                        <div class="value" style="color: white;" id="dashStripe">0,00 €</div>
                    </div>
                </div>
            </div>
            
            <!-- FACTURAS -->
            <div id="facturas" class="tab-content">
                <h2>Generador de Facturas</h2>
                
                <div class="info-box">
                    <strong>Información:</strong> Tus datos están precargados. Solo completa los datos del cliente y el servicio.
                </div>
                
                <div class="form-grid" style="max-width: 800px;">
                    <div class="form-group">
                        <label>Tipo de Factura</label>
                        <select id="tipoFactura" onchange="ajustarTipoFactura()">
                            <option value="amazon">Amazon KDP</option>
                            <option value="upwork">UpWork (USD)</option>
                            <option value="stripe">Stripe - Coaching</option>
                            <option value="otros">Otros Servicios</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Número de Factura</label>
                        <input type="text" id="numFactura" value="2025/001">
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha de Emisión</label>
                        <input type="date" id="fechaFactura">
                    </div>
                </div>
                
                <div id="conversorUSD" class="modelo-box" style="display: none;">
                    <h3>Conversor USD → EUR</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cantidad en USD</label>
                            <input type="number" step="0.01" id="cantidadUSD" placeholder="150.00" onchange="convertirUSD()">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Cambio</label>
                            <input type="number" step="0.0001" id="tipoCambio" placeholder="1.0850" value="1.0850" onchange="convertirUSD()">
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 16px; background: #E3F2FD; border-radius: 10px; text-align: center;">
                        <strong style="font-size: 1.3em; color: #007AFF;">Equivalente: <span id="equivalenteEUR">0,00 €</span></strong>
                    </div>
                </div>
                
                <h3>Datos del Cliente</h3>
                <div class="form-grid" id="datosCliente"></div>
                
                <h3>Detalles del Servicio</h3>
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Descripción del Servicio</label>
                        <textarea id="descripcionServ" rows="3" style="resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Base Imponible (€)</label>
                        <input type="number" step="0.01" id="baseImp" placeholder="0.00" onchange="calcularTotalesFactura()">
                    </div>
                    
                    <div class="form-group">
                        <label>IVA (%)</label>
                        <input type="number" id="porcIVA" value="0" onchange="calcularTotalesFactura()">
                    </div>
                    
                    <div class="form-group">
                        <label>Retención IRPF (%)</label>
                        <input type="number" id="porcRetencion" value="7" onchange="calcularTotalesFactura()">
                    </div>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label>IVA (€)</label>
                        <input type="number" step="0.01" id="importeIVA" readonly style="background: #F5F5F7;">
                    </div>
                    <div class="form-group">
                        <label>Retención (€)</label>
                        <input type="number" step="0.01" id="importeRetencion" readonly style="background: #F5F5F7;">
                    </div>
                    <div class="form-group">
                        <label style="color: #007AFF; font-weight: 600; font-size: 1.1em;">TOTAL (€)</label>
                        <input type="number" step="0.01" id="totalFactura" readonly style="background: #E3F2FD; font-weight: 700; font-size: 1.4em; color: #007AFF;">
                    </div>
                </div>
                
                <div class="acciones" style="margin-top: 24px;">
                    <button class="btn" onclick="guardarFactura()">Guardar Factura</button>
                    <button class="btn btn-secondary" onclick="previsualizarFactura()">Vista Previa</button>
                    <button class="btn btn-warning" onclick="limpiarFormularioFactura()">Nueva Factura</button>
                </div>
                
                <div id="vistaPrevia" style="display: none;"></div>
                
                <h3 style="margin-top: 48px;">Facturas Registradas</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Número</th>
                            <th>Tipo</th>
                            <th>Cliente</th>
                            <th>Base</th>
                            <th>IVA</th>
                            <th>Ret.</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaFacturas">
                        <tr><td colspan="9" style="text-align: center; color: #86868B;">No hay facturas registradas</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- GASTOS -->
            <div id="gastos" class="tab-content">
                <h2>Registro de Gastos Deducibles</h2>
                
                <div class="warning-box">
                    <strong>Importante:</strong> Solo registra gastos deducibles relacionados con tu actividad. Guarda todas las facturas y tickets originales.
                </div>
                
                <h3>Nuevo Gasto</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="fechaGasto">
                    </div>
                    
                    <div class="form-group">
                        <label>Categoría</label>
                        <select id="categoriaGasto" onchange="sugerirDeducible()">
                            <option value="cuota_ss">Cuota Autónomos</option>
                            <option value="comisiones_amazon">Comisiones Amazon</option>
                            <option value="comisiones_upwork">Comisiones UpWork</option>
                            <option value="comisiones_stripe">Comisiones Stripe</option>
                            <option value="publicidad">Publicidad Amazon</option>
                            <option value="software">Software (Canva, Claude AI, etc)</option>
                            <option value="formacion">Formación</option>
                            <option value="internet_movil">Internet/Móvil</option>
                            <option value="suministros">Suministros Casa</option>
                            <option value="hosting">Hosting/Dominio</option>
                            <option value="material">Material Oficina</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Proveedor</label>
                        <input type="text" id="proveedorGasto" placeholder="Nombre del proveedor">
                    </div>
                    
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Concepto</label>
                        <input type="text" id="conceptoGasto" placeholder="Descripción del gasto">
                    </div>
                    
                    <div class="form-group">
                        <label>Base Imponible (€)</label>
                        <input type="number" step="0.01" id="baseGasto" placeholder="0.00" onchange="calcularTotalesGasto()">
                    </div>
                    
                    <div class="form-group">
                        <label>IVA (%)</label>
                        <select id="porcIVAGasto" onchange="calcularTotalesGasto()">
                            <option value="0">0% (Sin IVA)</option>
                            <option value="4">4%</option>
                            <option value="10">10%</option>
                            <option value="21" selected>21%</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>% Deducible</label>
                        <input type="number" id="porcDeducible" value="100" min="0" max="100" placeholder="100">
                    </div>
                    
                    <div class="form-group">
                        <label>IVA (€)</label>
                        <input type="number" step="0.01" id="ivaGasto" readonly style="background: #F5F5F7;">
                    </div>
                    
                    <div class="form-group">
                        <label>Total (€)</label>
                        <input type="number" step="0.01" id="totalGasto" readonly style="background: #F5F5F7;">
                    </div>
                    
                    <div class="form-group">
                        <label>Número Factura/Ticket</label>
                        <input type="text" id="numeroGasto" placeholder="Referencia">
                    </div>
                </div>
                
                <button class="btn" onclick="guardarGasto()">Guardar Gasto</button>
                
                <h3 style="margin-top: 48px;">Gastos Registrados</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Categoría</th>
                            <th>Proveedor</th>
                            <th>Concepto</th>
                            <th>Base</th>
                            <th>IVA</th>
                            <th>Total</th>
                            <th>% Ded.</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaGastos">
                        <tr><td colspan="9" style="text-align: center; color: #86868B;">No hay gastos registrados</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- MODELO 303 -->
            <div id="modelo303" class="tab-content">
                <h2>Modelo 303 - IVA Trimestral</h2>
                
                <div id="alerta303Box"></div>
                
                <div class="info-box">
                    <strong>Plazo de presentación:</strong> Hasta el día 20 del mes siguiente al trimestre (20 Enero, Abril, Julio, Octubre)
                </div>
                
                <div class="form-grid" style="max-width: 400px;">
                    <div class="form-group">
                        <label>Selecciona Trimestre</label>
                        <select id="trimestre303" onchange="calcular303()">
                            <option value="4-2025" selected>4T 2025 (Nov-Dic)</option>
                            <option value="1-2026">1T 2026 (Ene-Feb-Mar)</option>
                            <option value="2-2026">2T 2026 (Abr-May-Jun)</option>
                            <option value="3-2026">3T 2026 (Jul-Ago-Sep)</option>
                            <option value="4-2026">4T 2026 (Oct-Nov-Dic)</option>
                        </select>
                    </div>
                </div>
                
                <div class="modelo-box">
                    <div class="modelo-title">IVA Repercutido (cobrado)</div>
                    
                    <div class="row-item">
                        <span>Base imponible 21% (Coaching):</span>
                        <strong id="m303_base21">0,00 €</strong>
                    </div>
                    <div class="row-item">
                        <span>Cuota IVA 21%:</span>
                        <strong id="m303_iva21">0,00 €</strong>
                    </div>
                    <div class="row-item">
                        <span>Operaciones exentas (Amazon, UpWork):</span>
                        <strong id="m303_exentas">0,00 €</strong>
                    </div>
                    <div class="row-item total">
                        <span>TOTAL IVA REPERCUTIDO</span>
                        <strong id="m303_totalRep">0,00 €</strong>
                    </div>
                </div>
                
                <div class="modelo-box">
                    <div class="modelo-title">IVA Soportado (pagado)</div>
                    
                    <div class="row-item">
                        <span>Cuota IVA soportado deducible:</span>
                        <strong id="m303_ivaSop">0,00 €</strong>
                    </div>
                    <div class="row-item">
                        <span>Base imponible gastos:</span>
                        <strong id="m303_baseGastos">0,00 €</strong>
                    </div>
                </div>
                
                <div class="modelo-box" style="border: 2px solid #007AFF;">
                    <div class="modelo-title" style="color: #007AFF;">Resultado</div>
                    <div class="row-item total">
                        <span id="m303_textoResultado">A INGRESAR</span>
                        <strong id="m303_resultado">0,00 €</strong>
                    </div>
                </div>
                
                <div class="checkbox-control">
                    <input type="checkbox" id="check303_4_2025" onchange="guardarEstadoModelo('303', '4-2025', this.checked)">
                    <label for="check303_4_2025" style="cursor: pointer; margin: 0;">Marcar modelo 303 (4T 2025) como presentado</label>
                </div>
                
                <div class="guia-presentacion">
                    <h3>Cómo presentar el Modelo 303</h3>
                    <ol>
                        <li>Accede a <a href="https://sede.agenciatributaria.gob.es" target="_blank" style="color: #007AFF;">sede.agenciatributaria.gob.es</a></li>
                        <li>Identifícate con Certificado Digital o Cl@ve PIN</li>
                        <li>Busca "Modelo 303 - Declaración de IVA"</li>
                        <li>Selecciona el trimestre correspondiente</li>
                        <li>Rellena las casillas con los importes calculados arriba</li>
                        <li>Revisa cuidadosamente todos los datos</li>
                        <li>Presenta y descarga el justificante en PDF</li>
                        <li>Guarda el justificante y marca como presentado arriba</li>
                    </ol>
                </div>
            </div>
            
            <!-- MODELO 130 -->
            <div id="modelo130" class="tab-content">
                <h2>Modelo 130 - IRPF Trimestral</h2>
                
                <div id="alerta130Box"></div>
                
                <div class="info-box">
                    <strong>Importante:</strong> Solo debes presentar este modelo si menos del 70% de tus ingresos tienen retención aplicada.
                </div>
                
                <div class="form-grid" style="max-width: 400px;">
                    <div class="form-group">
                        <label>Selecciona Trimestre</label>
                        <select id="trimestre130" onchange="calcular130()">
                            <option value="4-2025" selected>4T 2025 (Nov-Dic)</option>
                            <option value="1-2026">1T 2026 (Ene-Feb-Mar)</option>
                            <option value="2-2026">2T 2026 (Abr-May-Jun)</option>
                            <option value="3-2026">3T 2026 (Jul-Ago-Sep)</option>
                            <option value="4-2026">4T 2026 (Oct-Nov-Dic)</option>
                        </select>
                    </div>
                </div>
                
                <div class="modelo-box">
                    <div class="modelo-title">Análisis de Obligación</div>
                    
                    <div class="row-item">
                        <span>Ingresos CON retención (Amazon):</span>
                        <strong id="m130_conRet">0,00 €</strong>
                    </div>
                    <div class="row-item">
                        <span>Ingresos SIN retención (UpWork + Stripe particulares):</span>
                        <strong id="m130_sinRet">0,00 €</strong>
                    </div>
                    <div class="row-item">
                        <span>Total ingresos trimestre:</span>
                        <strong id="m130_totalIng">0,00 €</strong>
                    </div>
                    <div class="row-item" style="background: #E3F2FD; padding: 12px; border-radius: 8px; margin-top: 12px;">
                        <span style="font-weight: 600;">% de ingresos CON retención:</span>
                        <strong id="m130_porcentaje" style="color: #007AFF; font-size: 1.2em;">0%</strong>
                    </div>
                </div>
                
                <div id="m130_obligacionBox"></div>
                <div id="m130_calculoBox" style="display: none;"></div>
                
                <div class="checkbox-control">
                    <input type="checkbox" id="check130_4_2025" onchange="guardarEstadoModelo('130', '4-2025', this.checked)">
                    <label for="check130_4_2025" style="cursor: pointer; margin: 0;">Marcar modelo 130 (4T 2025) como presentado</label>
                </div>
                
                <div class="guia-presentacion">
                    <h3>Cómo presentar el Modelo 130</h3>
                    <ol>
                        <li>Accede a <a href="https://sede.agenciatributaria.gob.es" target="_blank" style="color: #007AFF;">sede.agenciatributaria.gob.es</a></li>
                        <li>Identifícate con Certificado Digital o Cl@ve PIN</li>
                        <li>Busca "Modelo 130 - Pago fraccionado IRPF"</li>
                        <li>Selecciona el trimestre correspondiente</li>
                        <li>Rellena con los importes calculados arriba</li>
                        <li>Revisa y presenta</li>
                        <li>Descarga el justificante en PDF</li>
                        <li>Guarda el justificante y marca como presentado arriba</li>
                    </ol>
                </div>
            </div>
            
            <!-- RESUMEN -->
            <div id="resumen" class="tab-content">
                <h2>Resumen Anual 2025</h2>
                
                <div class="grid-2">
                    <div class="modelo-box">
                        <h3 style="color: #007AFF;">Ingresos por Fuente</h3>
                        <div class="row-item">
                            <span>Amazon KDP:</span>
                            <strong id="res_amazon">0,00 €</strong>
                        </div>
                        <div class="row-item">
                            <span>UpWork:</span>
                            <strong id="res_upwork">0,00 €</strong>
                        </div>
                        <div class="row-item">
                            <span>Stripe (Coaching):</span>
                            <strong id="res_stripe">0,00 €</strong>
                        </div>
                        <div class="row-item">
                            <span>Otros:</span>
                            <strong id="res_otros">0,00 €</strong>
                        </div>
                        <div class="row-item total">
                            <span>TOTAL INGRESOS</span>
                            <strong id="res_totalIng">0,00 €</strong>
                        </div>
                    </div>
                    
                    <div class="modelo-box">
                        <h3 style="color: #007AFF;">Gastos por Categoría</h3>
                        <div class="row-item">
                            <span>Cuota Autónomos:</span>
                            <strong id="res_cuota">0,00 €</strong>
                        </div>
                        <div class="row-item">
                            <span>Comisiones:</span>
                            <strong id="res_comisiones">0,00 €</strong>
                        </div>
                        <div class="row-item">
                            <span>Software:</span>
                            <strong id="res_software">0,00 €</strong>
                        </div>
                        <div class="row-item">
                            <span>Publicidad:</span>
                            <strong id="res_publicidad">0,00 €</strong>
                        </div>
                        <div class="row-item">
                            <span>Otros gastos:</span>
                            <strong id="res_otrosGastos">0,00 €</strong>
                        </div>
                        <div class="row-item total">
                            <span>TOTAL GASTOS</span>
                            <strong id="res_totalGastos">0,00 €</strong>
                        </div>
                    </div>
                </div>
                
                <div class="modelo-box" style="border: 2px solid #007AFF;">
                    <div class="modelo-title" style="color: #007AFF;">Resumen Fiscal Anual</div>
                    <div class="grid-2">
                        <div>
                            <div class="row-item">
                                <span>Beneficio Neto:</span>
                                <strong id="res_beneficio">0,00 €</strong>
                            </div>
                            <div class="row-item">
                                <span>IVA Repercutido:</span>
                                <strong id="res_ivaRep">0,00 €</strong>
                            </div>
                            <div class="row-item">
                                <span>IVA Soportado:</span>
                                <strong id="res_ivaSop">0,00 €</strong>
                            </div>
                        </div>
                        <div>
                            <div class="row-item">
                                <span>Retenciones IRPF:</span>
                                <strong id="res_retenciones">0,00 €</strong>
                            </div>
                            <div class="row-item">
                                <span>Nº Facturas emitidas:</span>
                                <strong id="res_numFacturas">0</strong>
                            </div>
                            <div class="row-item">
                                <span>Nº Gastos registrados:</span>
                                <strong id="res_numGastos">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <strong>Preparación Declaración de la Renta:</strong> Estos datos te servirán para completar tu declaración anual. Conserva todas las facturas y justificantes.
                </div>
            </div>
            
            <!-- UTILIDADES -->
            <div id="utilidades" class="tab-content">
                <h2>Gestión de Datos y Calendario Fiscal</h2>
                
                <div class="backup-section">
                    <h3 style="color: #007AFF; margin-bottom: 20px;">Copia de Seguridad</h3>
                    
                    <div class="backup-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="stat_facturas">0</div>
                            <div class="stat-label">Facturas</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat_gastos">0</div>
                            <div class="stat-label">Gastos</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat_ingresos">0 €</div>
                            <div class="stat-label">Ingresos Totales</div>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong>Recomendación:</strong> Exporta una copia de seguridad mensualmente y guárdala en un lugar seguro (Google Drive, Dropbox, etc.)
                    </div>
                    
                    <div class="acciones">
                        <button class="btn" onclick="exportarDatos()">Exportar JSON</button>
                        <button class="btn btn-secondary" onclick="exportarExcel()">Exportar Excel</button>
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">Importar Datos</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDatos(event)">
                    
                    <div class="warning-box" style="margin-top: 20px;">
                        <strong>Advertencia:</strong> Al importar datos se reemplazarán todos tus datos actuales. Asegúrate de hacer una copia de seguridad primero.
                    </div>
                </div>
                
                <div id="calendarioFiscal">
                    <h3 style="color: #007AFF; margin: 32px 0 20px;">Calendario Fiscal 2026</h3>
                    
                    <div id="proximaObligacionDestacada"></div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Vencimiento</th>
                                <th>Días Restantes</th>
                                <th>Modelos</th>
                                <th>Periodo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCalendario">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==================== DATOS GLOBALES ====================
        const MIS_DATOS = {
            nombre: "Javier Gómez Fernández",
            nif: "28838594-K",
            direccion: "C/Artemisa S/N, Urbanización las Azucenas, Casa 20, Lepe, Huelva, España",
            actividad: "774-2 Traductores e intérpretes",
            retencion: 7,
            fechaAlta: "2025-11-10"
        };
        
        let facturas = JSON.parse(localStorage.getItem('facturas') || '[]');
        let gastos = JSON.parse(localStorage.getItem('gastos') || '[]');
        let estadosModelos = JSON.parse(localStorage.getItem('estadosModelos') || '{}');
        
        // ==================== INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fechaFactura').valueAsDate = new Date();
            document.getElementById('fechaGasto').valueAsDate = new Date();
            ajustarTipoFactura();
            actualizarDashboard();
            actualizarListaFacturas();
            actualizarListaGastos();
            verificarVencimientos();
            calcular303();
            calcular130();
            actualizarResumen();
            cargarEstadosModelos();
            actualizarCalendarioFiscal();
            actualizarStatsBackup();
        });
        
        // ==================== NAVEGACIÓN ====================
        function cambiarTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'modelo303') calcular303();
            if (tabId === 'modelo130') calcular130();
            if (tabId === 'resumen') actualizarResumen();
            if (tabId === 'utilidades') {
                actualizarStatsBackup();
                actualizarCalendarioFiscal();
            }
        }
        
        // ==================== VENCIMIENTOS ====================
        function verificarVencimientos() {
            const hoy = new Date();
            const proximoVencimiento = new Date('2026-01-20');
            const diasRestantes = Math.ceil((proximoVencimiento - hoy) / (1000 * 60 * 60 * 24));
            
            const alertaDiv = document.getElementById('alertaVencimiento');
            
            if (diasRestantes <= 30 && diasRestantes > 0) {
                let claseAlerta = 'alert-vencimiento';
                if (diasRestantes <= 10) claseAlerta += ' alert-urgente';
                else if (diasRestantes <= 20) claseAlerta += ' alert-preparar';
                
                alertaDiv.className = claseAlerta;
                alertaDiv.innerHTML = `Próximo vencimiento: <strong>20 Enero 2026</strong> (Faltan ${diasRestantes} días) - Modelos 303 y 130`;
                alertaDiv.style.display = 'block';
            }
            
            // Dashboard box
            const proximoBox = document.getElementById('proximoVencimientoBox');
            if (diasRestantes > 0 && diasRestantes <= 30) {
                proximoBox.innerHTML = `
                    <div class="countdown-box">
                        <div class="countdown-label">Próximo Vencimiento</div>
                        <div class="countdown-days">${diasRestantes}</div>
                        <div style="font-size: 1.1em; opacity: 0.9;">días para presentar Modelos 303 y 130</div>
                        <div style="margin-top: 20px; font-size: 0.95em;">Fecha límite: <strong>20 Enero 2026</strong></div>
                        <div style="margin-top: 12px;">
                            <button class="btn" onclick="cambiarTab('modelo303'); event.stopPropagation();" style="margin: 4px;">Ver Modelo 303</button>
                            <button class="btn" onclick="cambiarTab('modelo130'); event.stopPropagation();" style="margin: 4px;">Ver Modelo 130</button>
                        </div>
                    </div>
                `;
            }
        }
        
        // ==================== FACTURAS ====================
        function ajustarTipoFactura() {
            const tipo = document.getElementById('tipoFactura').value;
            const conversorUSD = document.getElementById('conversorUSD');
            const datosCliente = document.getElementById('datosCliente');
            const porcIVA = document.getElementById('porcIVA');
            const porcRetencion = document.getElementById('porcRetencion');
            const descripcion = document.getElementById('descripcionServ');
            
            conversorUSD.style.display = 'none';
            
            switch(tipo) {
                case 'amazon':
                    datosCliente.innerHTML = `
                        <div class="form-group">
                            <label>Cliente</label>
                            <input type="text" value="Amazon Media EU S.à.r.l. Sucursal España" readonly style="background: #F5F5F7;">
                        </div>
                        <div class="form-group">
                            <label>NIF</label>
                            <input type="text" value="W-0184081-H" readonly style="background: #F5F5F7;">
                        </div>
                    `;
                    porcIVA.value = 0;
                    porcRetencion.value = 7;
                    descripcion.value = "Regalías por venta de libros en Amazon KDP - Periodo: [indicar mes]";
                    break;
                    
                case 'upwork':
                    conversorUSD.style.display = 'block';
                    datosCliente.innerHTML = `
                        <div class="form-group">
                            <label>Cliente</label>
                            <input type="text" id="nombreCliente" placeholder="Nombre del cliente USA">
                        </div>
                        <div class="form-group">
                            <label>País</label>
                            <input type="text" value="Estados Unidos" readonly style="background: #F5F5F7;">
                        </div>
                    `;
                    porcIVA.value = 0;
                    porcRetencion.value = 0;
                    descripcion.value = "Servicios de corrección y edición de artículos de psicología";
                    break;
                    
                case 'stripe':
                    datosCliente.innerHTML = `
                        <div class="form-group">
                            <label>Cliente</label>
                            <input type="text" id="nombreCliente" placeholder="Nombre completo">
                        </div>
                        <div class="form-group">
                            <label>NIF (si es empresa)</label>
                            <input type="text" id="nifCliente" placeholder="12345678X">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="tipoClienteStripe" onchange="ajustarRetencionStripe()">
                                <option value="particular" selected>Particular</option>
                                <option value="empresa">Empresa/Autónomo</option>
                            </select>
                        </div>
                    `;
                    porcIVA.value = 21;
                    porcRetencion.value = 0;
                    descripcion.value = "Servicios de coaching profesional";
                    break;
                    
                case 'otros':
                    datosCliente.innerHTML = `
                        <div class="form-group">
                            <label>Cliente</label>
                            <input type="text" id="nombreCliente" placeholder="Nombre del cliente">
                        </div>
                        <div class="form-group">
                            <label>NIF</label>
                            <input type="text" id="nifCliente" placeholder="12345678X (opcional)">
                        </div>
                    `;
                    porcIVA.value = 21;
                    porcRetencion.value = 0;
                    descripcion.value = "";
                    break;
            }
            
            calcularTotalesFactura();
        }
        
        function ajustarRetencionStripe() {
            const tipo = document.getElementById('tipoClienteStripe').value;
            document.getElementById('porcRetencion').value = tipo === 'empresa' ? 7 : 0;
            calcularTotalesFactura();
        }
        
        function convertirUSD() {
            const usd = parseFloat(document.getElementById('cantidadUSD').value) || 0;
            const cambio = parseFloat(document.getElementById('tipoCambio').value) || 0;
            
            if (usd > 0 && cambio > 0) {
                const eur = usd / cambio;
                document.getElementById('equivalenteEUR').textContent = eur.toFixed(2) + ' €';
                document.getElementById('baseImp').value = eur.toFixed(2);
                calcularTotalesFactura();
            }
        }
        
        function calcularTotalesFactura() {
            const base = parseFloat(document.getElementById('baseImp').value) || 0;
            const porcIVA = parseFloat(document.getElementById('porcIVA').value) || 0;
            const porcRet = parseFloat(document.getElementById('porcRetencion').value) || 0;
            
            const iva = (base * porcIVA) / 100;
            const retencion = (base * porcRet) / 100;
            const total = base + iva - retencion;
            
            document.getElementById('importeIVA').value = iva.toFixed(2);
            document.getElementById('importeRetencion').value = retencion.toFixed(2);
            document.getElementById('totalFactura').value = total.toFixed(2);
        }
        
        function guardarFactura() {
            const tipo = document.getElementById('tipoFactura').value;
            const fecha = document.getElementById('fechaFactura').value;
            const numero = document.getElementById('numFactura').value;
            const base = parseFloat(document.getElementById('baseImp').value);
            const descripcion = document.getElementById('descripcionServ').value;
            
            if (!fecha || !numero || !base || !descripcion) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }
            
            let cliente = '';
            if (tipo === 'amazon') {
                cliente = 'Amazon Media EU';
            } else {
                const nombreCliente = document.getElementById('nombreCliente');
                if (nombreCliente) {
                    cliente = nombreCliente.value;
                    if (!cliente) {
                        alert('Por favor, indica el nombre del cliente');
                        return;
                    }
                }
            }
            
            const iva = parseFloat(document.getElementById('importeIVA').value);
            const retencion = parseFloat(document.getElementById('importeRetencion').value);
            const total = parseFloat(document.getElementById('totalFactura').value);
            const porcIVA = parseFloat(document.getElementById('porcIVA').value);
            const porcRet = parseFloat(document.getElementById('porcRetencion').value);
            
            const factura = {
                id: Date.now(),
                fecha,
                numero,
                tipo,
                cliente,
                descripcion,
                base,
                porcIVA,
                iva,
                porcRetencion: porcRet,
                retencion,
                total
            };
            
            facturas.push(factura);
            localStorage.setItem('facturas', JSON.stringify(facturas));
            
            const partes = numero.split('/');
            if (partes.length === 2) {
                const num = parseInt(partes[1]) + 1;
                document.getElementById('numFactura').value = partes[0] + '/' + num.toString().padStart(3, '0');
            }
            
            actualizarListaFacturas();
            actualizarDashboard();
            limpiarFormularioFactura();
            
            document.getElementById('facturas').classList.add('success-pulse');
            setTimeout(() => document.getElementById('facturas').classList.remove('success-pulse'), 500);
            
            alert('✓ Factura guardada correctamente');
        }
        
        function limpiarFormularioFactura() {
            document.getElementById('baseImp').value = '';
            document.getElementById('importeIVA').value = '';
            document.getElementById('importeRetencion').value = '';
            document.getElementById('totalFactura').value = '';
            document.getElementById('cantidadUSD').value = '';
            document.getElementById('equivalenteEUR').textContent = '0,00 €';
            
            const nombreCliente = document.getElementById('nombreCliente');
            if (nombreCliente) nombreCliente.value = '';
            
            ajustarTipoFactura();
        }
        
        function actualizarListaFacturas() {
            const tbody = document.getElementById('listaFacturas');
            
            if (facturas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #86868B;">No hay facturas registradas</td></tr>';
                return;
            }
            
            tbody.innerHTML = facturas.map(f => {
                let badgeClass = 'badge-otros';
                if (f.tipo === 'amazon') badgeClass = 'badge-amazon';
                if (f.tipo === 'upwork') badgeClass = 'badge-upwork';
                if (f.tipo === 'stripe') badgeClass = 'badge-stripe';
                
                return `
                    <tr>
                        <td>${new Date(f.fecha).toLocaleDateString('es-ES')}</td>
                        <td><strong>${f.numero}</strong></td>
                        <td><span class="badge ${badgeClass}">${f.tipo}</span></td>
                        <td>${f.cliente}</td>
                        <td>${f.base.toFixed(2)} €</td>
                        <td>${f.iva.toFixed(2)} €</td>
                        <td>${f.retencion.toFixed(2)} €</td>
                        <td><strong>${f.total.toFixed(2)} €</strong></td>
                        <td>
                            <button class="btn btn-small btn-warning" onclick="eliminarFactura(${f.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function eliminarFactura(id) {
            if (confirm('¿Estás seguro de eliminar esta factura?')) {
                facturas = facturas.filter(f => f.id !== id);
                localStorage.setItem('facturas', JSON.stringify(facturas));
                actualizarListaFacturas();
                actualizarDashboard();
            }
        }
        
        function previsualizarFactura() {
            const tipo = document.getElementById('tipoFactura').value;
            const fecha = document.getElementById('fechaFactura').value;
            const numero = document.getElementById('numFactura').value;
            const base = parseFloat(document.getElementById('baseImp').value);
            const descripcion = document.getElementById('descripcionServ').value;
            
            if (!fecha || !numero || !base || !descripcion) {
                alert('Por favor, completa todos los campos obligatorios antes de previsualizar');
                return;
            }
            
            let cliente = '';
            let nifCliente = '';
            
            if (tipo === 'amazon') {
                cliente = 'Amazon Media EU S.à.r.l. Sucursal España';
                nifCliente = 'W-0184081-H';
            } else {
                const nombreCliente = document.getElementById('nombreCliente');
                if (nombreCliente) cliente = nombreCliente.value || 'Cliente sin especificar';
                const nifInput = document.getElementById('nifCliente');
                if (nifInput) nifCliente = nifInput.value;
            }
            
            const iva = parseFloat(document.getElementById('importeIVA').value);
            const retencion = parseFloat(document.getElementById('importeRetencion').value);
            const total = parseFloat(document.getElementById('totalFactura').value);
            const porcIVA = parseFloat(document.getElementById('porcIVA').value);
            const porcRet = parseFloat(document.getElementById('porcRetencion').value);
            
            let observaciones = '';
            if (tipo === 'amazon') {
                observaciones = 'Operación exenta de IVA - Art. 20.Uno.26º LIVA (Libros)';
            } else if (tipo === 'upwork') {
                observaciones = 'Operación exenta de IVA - Inversión del sujeto pasivo. Prestación de servicios Art. 69 y 70 Ley 37/1992 LIVA.';
            }
            
            const preview = `
                <div class="factura-preview">
                    <div class="factura-header">
                        <div>
                            <div class="factura-title">FACTURA</div>
                        </div>
                        <div class="factura-numero">
                            <div><strong>Nº:</strong> ${numero}</div>
                            <div><strong>Fecha:</strong> ${new Date(fecha).toLocaleDateString('es-ES')}</div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="datos-section">
                            <h3>DATOS DEL EMISOR</h3>
                            <p><strong>${MIS_DATOS.nombre}</strong></p>
                            <p>NIF: ${MIS_DATOS.nif}</p>
                            <p>${MIS_DATOS.direccion}</p>
                            <p>${MIS_DATOS.actividad}</p>
                        </div>
                        
                        <div class="datos-section">
                            <h3>DATOS DEL CLIENTE</h3>
                            <p><strong>${cliente}</strong></p>
                            ${nifCliente ? `<p>NIF: ${nifCliente}</p>` : ''}
                        </div>
                    </div>
                    
                    <table style="margin: 32px 0;">
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th style="text-align: right; width: 140px;">Importe</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${descripcion}</td>
                                <td style="text-align: right;">${base.toFixed(2)} €</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 32px;">
                        <div style="display: flex; justify-content: flex-end; gap: 60px; margin: 12px 0; font-size: 1.05em;">
                            <span>Base Imponible:</span>
                            <strong>${base.toFixed(2)} €</strong>
                        </div>
                        ${iva > 0 ? `
                        <div style="display: flex; justify-content: flex-end; gap: 60px; margin: 12px 0; font-size: 1.05em;">
                            <span>IVA (${porcIVA}%):</span>
                            <strong>${iva.toFixed(2)} €</strong>
                        </div>
                        ` : ''}
                        ${retencion > 0 ? `
                        <div style="display: flex; justify-content: flex-end; gap: 60px; margin: 12px 0; font-size: 1.05em;">
                            <span>Retención IRPF (${porcRet}%):</span>
                            <strong>-${retencion.toFixed(2)} €</strong>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: flex-end; gap: 60px; margin-top: 20px; padding-top: 16px; border-top: 2px solid #1D1D1F; font-size: 1.4em; font-weight: 700;">
                            <span>TOTAL:</span>
                            <strong style="color: #007AFF;">${total.toFixed(2)} €</strong>
                        </div>
                    </div>
                    
                    ${observaciones ? `
                    <div style="margin-top: 40px; padding: 16px; background: #F5F5F7; border-radius: 10px; font-size: 0.95em; color: #515154;">
                        <strong>Observaciones:</strong><br>
                        ${observaciones}
                    </div>
                    ` : ''}
                    
                    <div class="acciones" style="margin-top: 32px;">
                        <button class="btn" onclick="descargarPDF()">Descargar PDF</button>
                        <button class="btn btn-warning" onclick="cerrarPreview()">Cerrar</button>
                    </div>
                </div>
            `;
            
            document.getElementById('vistaPrevia').innerHTML = preview;
            document.getElementById('vistaPrevia').style.display = 'block';
            document.getElementById('vistaPrevia').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cerrarPreview() {
            document.getElementById('vistaPrevia').style.display = 'none';
        }
        
        function descargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const tipo = document.getElementById('tipoFactura').value;
            const fecha = document.getElementById('fechaFactura').value;
            const numero = document.getElementById('numFactura').value;
            const base = parseFloat(document.getElementById('baseImp').value);
            const descripcion = document.getElementById('descripcionServ').value;
            const iva = parseFloat(document.getElementById('importeIVA').value);
            const retencion = parseFloat(document.getElementById('importeRetencion').value);
            const total = parseFloat(document.getElementById('totalFactura').value);
            const porcIVA = parseFloat(document.getElementById('porcIVA').value);
            const porcRet = parseFloat(document.getElementById('porcRetencion').value);
            
            let cliente = '';
            let nifCliente = '';
            
            if (tipo === 'amazon') {
                cliente = 'Amazon Media EU S.à.r.l. Sucursal España';
                nifCliente = 'W-0184081-H';
            } else {
                const nombreCliente = document.getElementById('nombreCliente');
                if (nombreCliente) cliente = nombreCliente.value;
                const nifInput = document.getElementById('nifCliente');
                if (nifInput) nifCliente = nifInput.value;
            }
            
            // Header
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('FACTURA', 20, 25);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Nº: ${numero}`, 150, 20);
            doc.text(`Fecha: ${new Date(fecha).toLocaleDateString('es-ES')}`, 150, 27);
            
            // Emisor
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DATOS DEL EMISOR', 20, 45);
            doc.setFont(undefined, 'normal');
            doc.text(MIS_DATOS.nombre, 20, 52);
            doc.text(`NIF: ${MIS_DATOS.nif}`, 20, 58);
            doc.text(MIS_DATOS.direccion, 20, 64);
            doc.text(MIS_DATOS.actividad, 20, 70);
            
            // Cliente
            doc.setFont(undefined, 'bold');
            doc.text('DATOS DEL CLIENTE', 120, 45);
            doc.setFont(undefined, 'normal');
            doc.text(cliente, 120, 52);
            if (nifCliente) doc.text(`NIF: ${nifCliente}`, 120, 58);
            
            // Línea separadora
            doc.line(20, 80, 190, 80);
            
            // Descripción
            doc.setFontSize(10);
            doc.text('Descripción', 20, 90);
            doc.text('Importe', 170, 90);
            doc.line(20, 92, 190, 92);
            
            const splitDesc = doc.splitTextToSize(descripcion, 140);
            doc.text(splitDesc, 20, 100);
            doc.text(`${base.toFixed(2)} €`, 170, 100);
            
            // Totales
            let yPos = 120;
            doc.line(20, yPos, 190, yPos);
            yPos += 10;
            
            doc.text('Base Imponible:', 120, yPos);
            doc.text(`${base.toFixed(2)} €`, 170, yPos);
            yPos += 7;
            
            if (iva > 0) {
                doc.text(`IVA (${porcIVA}%):`, 120, yPos);
                doc.text(`${iva.toFixed(2)} €`, 170, yPos);
                yPos += 7;
            }
            
            if (retencion > 0) {
                doc.text(`Retención IRPF (${porcRet}%):`, 120, yPos);
                doc.text(`-${retencion.toFixed(2)} €`, 170, yPos);
                yPos += 7;
            }
            
            yPos += 3;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('TOTAL:', 120, yPos);
            doc.text(`${total.toFixed(2)} €`, 170, yPos);
            
            // Observaciones
            if (tipo === 'amazon' || tipo === 'upwork') {
                yPos += 15;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                if (tipo === 'amazon') {
                    doc.text('Operación exenta de IVA - Art. 20.Uno.26º LIVA (Libros)', 20, yPos);
                } else {
                    const obs = doc.splitTextToSize('Operación exenta de IVA - Inversión del sujeto pasivo. Prestación de servicios Art. 69 y 70 Ley 37/1992 LIVA.', 170);
                    doc.text(obs, 20, yPos);
                }
            }
            
            doc.save(`Factura_${numero.replace('/', '_')}.pdf`);
        }
        
        // ==================== GASTOS ====================
        function sugerirDeducible() {
            const cat = document.getElementById('categoriaGasto').value;
            const deducibleInput = document.getElementById('porcDeducible');
            
            if (cat === 'internet_movil' || cat === 'suministros') {
                deducibleInput.value = 30;
            } else {
                deducibleInput.value = 100;
            }
        }
        
        function calcularTotalesGasto() {
            const base = parseFloat(document.getElementById('baseGasto').value) || 0;
            const porcIVA = parseFloat(document.getElementById('porcIVAGasto').value) || 0;
            
            const iva = (base * porcIVA) / 100;
            const total = base + iva;
            
            document.getElementById('ivaGasto').value = iva.toFixed(2);
            document.getElementById('totalGasto').value = total.toFixed(2);
        }
        
        function guardarGasto() {
            const fecha = document.getElementById('fechaGasto').value;
            const categoria = document.getElementById('categoriaGasto').value;
            const proveedor = document.getElementById('proveedorGasto').value;
            const concepto = document.getElementById('conceptoGasto').value;
            const base = parseFloat(document.getElementById('baseGasto').value);
            
            if (!fecha || !proveedor || !concepto || !base) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }
            
            const porcIVA = parseFloat(document.getElementById('porcIVAGasto').value);
            const porcDeducible = parseFloat(document.getElementById('porcDeducible').value);
            const iva = parseFloat(document.getElementById('ivaGasto').value);
            const total = parseFloat(document.getElementById('totalGasto').value);
            const numero = document.getElementById('numeroGasto').value;
            
            const gasto = {
                id: Date.now(),
                fecha,
                categoria,
                proveedor,
                concepto,
                base,
                porcIVA,
                iva,
                total,
                porcDeducible,
                numero
            };
            
            gastos.push(gasto);
            localStorage.setItem('gastos', JSON.stringify(gastos));
            
            actualizarListaGastos();
            actualizarDashboard();
            limpiarFormularioGasto();
            
            document.getElementById('gastos').classList.add('success-pulse');
            setTimeout(() => document.getElementById('gastos').classList.remove('success-pulse'), 500);
            
            alert('✓ Gasto guardado correctamente');
        }
        
        function limpiarFormularioGasto() {
            document.getElementById('proveedorGasto').value = '';
            document.getElementById('conceptoGasto').value = '';
            document.getElementById('baseGasto').value = '';
            document.getElementById('ivaGasto').value = '';
            document.getElementById('totalGasto').value = '';
            document.getElementById('numeroGasto').value = '';
            document.getElementById('porcDeducible').value = '100';
        }
        
        function actualizarListaGastos() {
            const tbody = document.getElementById('listaGastos');
            
            if (gastos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #86868B;">No hay gastos registrados</td></tr>';
                return;
            }
            
            tbody.innerHTML = gastos.map(g => `
                <tr>
                    <td>${new Date(g.fecha).toLocaleDateString('es-ES')}</td>
                    <td><span class="badge badge-otros">${g.categoria.replace(/_/g, ' ')}</span></td>
                    <td>${g.proveedor}</td>
                    <td>${g.concepto}</td>
                    <td>${g.base.toFixed(2)} €</td>
                    <td>${g.iva.toFixed(2)} €</td>
                    <td><strong>${g.total.toFixed(2)} €</strong></td>
                    <td>${g.porcDeducible}%</td>
                    <td>
                        <button class="btn btn-small btn-warning" onclick="eliminarGasto(${g.id})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function eliminarGasto(id) {
            if (confirm('¿Estás seguro de eliminar este gasto?')) {
                gastos = gastos.filter(g => g.id !== id);
                localStorage.setItem('gastos', JSON.stringify(gastos));
                actualizarListaGastos();
                actualizarDashboard();
            }
        }
        
        // ==================== DASHBOARD ====================
        function actualizarDashboard() {
            const totalIngresos = facturas.reduce((sum, f) => sum + f.base, 0);
            const totalGastos = gastos.reduce((sum, g) => sum + (g.base * g.porcDeducible / 100), 0);
            const beneficio = totalIngresos - totalGastos;
            
            const ivaRepercutido = facturas.reduce((sum, f) => sum + f.iva, 0);
            const ivaSoportado = gastos.reduce((sum, g) => sum + (g.iva * g.porcDeducible / 100), 0);
            const saldoIva = ivaRepercutido - ivaSoportado;
            
            const retenciones = facturas.reduce((sum, f) => sum + f.retencion, 0);
            
            document.getElementById('dashIngresos').textContent = totalIngresos.toFixed(2) + ' €';
            document.getElementById('dashGastos').textContent = totalGastos.toFixed(2) + ' €';
            document.getElementById('dashBeneficio').textContent = beneficio.toFixed(2) + ' €';
            document.getElementById('dashIva').textContent = saldoIva.toFixed(2) + ' €';
            document.getElementById('dashRetenciones').textContent = retenciones.toFixed(2) + ' €';
            
            const amazon = facturas.filter(f => f.tipo === 'amazon').reduce((sum, f) => sum + f.base, 0);
            const upwork = facturas.filter(f => f.tipo === 'upwork').reduce((sum, f) => sum + f.base, 0);
            const stripe = facturas.filter(f => f.tipo === 'stripe').reduce((sum, f) => sum + f.base, 0);
            
            document.getElementById('dashAmazon').textContent = amazon.toFixed(2) + ' €';
            document.getElementById('dashUpwork').textContent = upwork.toFixed(2) + ' €';
            document.getElementById('dashStripe').textContent = stripe.toFixed(2) + ' €';
        }
        
        // ==================== MODELO 303 ====================
        function calcular303() {
            const trimestre = document.getElementById('trimestre303').value;
            const [trim, anio] = trimestre.split('-');
            
            const facturasTrim = facturas.filter(f => {
                const fecha = new Date(f.fecha);
                const anioF = fecha.getFullYear();
                const mes = fecha.getMonth() + 1;
                const trimF = Math.ceil(mes / 3);
                return anioF == anio && trimF == trim;
            });
            
            const gastosTrim = gastos.filter(g => {
                const fecha = new Date(g.fecha);
                const anioG = fecha.getFullYear();
                const mes = fecha.getMonth() + 1;
                const trimG = Math.ceil(mes / 3);
                return anioG == anio && trimG == trim;
            });
            
            const base21 = facturasTrim.filter(f => f.porcIVA === 21).reduce((sum, f) => sum + f.base, 0);
            const iva21 = facturasTrim.filter(f => f.porcIVA === 21).reduce((sum, f) => sum + f.iva, 0);
            const exentas = facturasTrim.filter(f => f.porcIVA === 0).reduce((sum, f) => sum + f.base, 0);
            const totalRep = iva21;
            
            const baseGastos = gastosTrim.reduce((sum, g) => sum + (g.base * g.porcDeducible / 100), 0);
            const ivaSop = gastosTrim.reduce((sum, g) => sum + (g.iva * g.porcDeducible / 100), 0);
            
            const resultado = totalRep - ivaSop;
            
            document.getElementById('m303_base21').textContent = base21.toFixed(2) + ' €';
            document.getElementById('m303_iva21').textContent = iva21.toFixed(2) + ' €';
            document.getElementById('m303_exentas').textContent = exentas.toFixed(2) + ' €';
            document.getElementById('m303_totalRep').textContent = totalRep.toFixed(2) + ' €';
            document.getElementById('m303_baseGastos').textContent = baseGastos.toFixed(2) + ' €';
            document.getElementById('m303_ivaSop').textContent = ivaSop.toFixed(2) + ' €';
            document.getElementById('m303_resultado').textContent = Math.abs(resultado).toFixed(2) + ' €';
            
            const textoResultado = document.getElementById('m303_textoResultado');
            if (resultado > 0) {
                textoResultado.textContent = 'A INGRESAR';
            } else if (resultado < 0) {
                textoResultado.textContent = 'A DEVOLVER';
            } else {
                textoResultado.textContent = 'NEUTRO';
            }
            
            mostrarAlerta303(trimestre);
        }
        
        function mostrarAlerta303(trimestre) {
            const alertaBox = document.getElementById('alerta303Box');
            const fechasLimite = {
                '4-2025': '2026-01-20',
                '1-2026': '2026-04-20',
                '2-2026': '2026-07-20',
                '3-2026': '2026-10-20',
                '4-2026': '2027-01-20'
            };
            
            const fechaLimite = new Date(fechasLimite[trimestre]);
            const hoy = new Date();
            const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
            
            if (diasRestantes > 0 && diasRestantes <= 30) {
                let claseAlerta = 'alert-vencimiento';
                if (diasRestantes <= 10) claseAlerta += ' alert-urgente';
                else if (diasRestantes <= 20) claseAlerta += ' alert-preparar';
                
                alertaBox.innerHTML = `
                    <div class="${claseAlerta}">
                        Vence el ${fechaLimite.toLocaleDateString('es-ES')} - Faltan ${diasRestantes} días
                    </div>
                `;
            } else {
                alertaBox.innerHTML = '';
            }
        }
        
        // ==================== MODELO 130 ====================
        function calcular130() {
            const trimestre = document.getElementById('trimestre130').value;
            const [trim, anio] = trimestre.split('-');
            
            const facturasTrim = facturas.filter(f => {
                const fecha = new Date(f.fecha);
                const anioF = fecha.getFullYear();
                const mes = fecha.getMonth() + 1;
                const trimF = Math.ceil(mes / 3);
                return anioF == anio && trimF == trim;
            });
            
            const ingresosConRet = facturasTrim.filter(f => f.retencion > 0).reduce((sum, f) => sum + f.base, 0);
            const ingresosSinRet = facturasTrim.filter(f => f.retencion === 0).reduce((sum, f) => sum + f.base, 0);
            const totalIng = ingresosConRet + ingresosSinRet;
            
            const porcentajeConRet = totalIng > 0 ? (ingresosConRet / totalIng * 100) : 0;
            
            document.getElementById('m130_conRet').textContent = ingresosConRet.toFixed(2) + ' €';
            document.getElementById('m130_sinRet').textContent = ingresosSinRet.toFixed(2) + ' €';
            document.getElementById('m130_totalIng').textContent = totalIng.toFixed(2) + ' €';
            document.getElementById('m130_porcentaje').textContent = porcentajeConRet.toFixed(1) + '%';
            
            const obligacionBox = document.getElementById('m130_obligacionBox');
            const calculoBox = document.getElementById('m130_calculoBox');
            
            if (porcentajeConRet >= 70) {
                obligacionBox.innerHTML = `
                    <div class="modelo-box" style="border: 2px solid #34C759;">
                        <div class="modelo-title" style="color: #34C759;">✓ No debes presentar el Modelo 130</div>
                        <p style="color: #515154; line-height: 1.6;">Más del 70% de tus ingresos tienen retención (${porcentajeConRet.toFixed(1)}%). Estás exento de presentar este modelo.</p>
                    </div>
                `;
                calculoBox.style.display = 'none';
            } else {
                obligacionBox.innerHTML = `
                    <div class="modelo-box" style="border: 2px solid #FF9500;">
                        <div class="modelo-title" style="color: #FF9500;">⚠️ Sí debes presentar el Modelo 130</div>
                        <p style="color: #515154; line-height: 1.6;">Solo el ${porcentajeConRet.toFixed(1)}% de tus ingresos tienen retención (menos del 70%). Debes presentar el modelo 130.</p>
                    </div>
                `;
                calculoBox.style.display = 'block';
                
                const gastosTrim = gastos.filter(g => {
                    const fecha = new Date(g.fecha);
                    const anioG = fecha.getFullYear();
                    const mes = fecha.getMonth() + 1;
                    const trimG = Math.ceil(mes / 3);
                    return anioG == anio && trimG == trim;
                });
                
                const gastosDeducibles = gastosTrim.reduce((sum, g) => sum + (g.base * g.porcDeducible / 100), 0);
                const rendNeto = totalIng - gastosDeducibles;
                const pago20 = rendNeto * 0.20;
                const retenciones = facturasTrim.reduce((sum, f) => sum + f.retencion, 0);
                const resultado = Math.max(0, pago20 - retenciones);
                
                calculoBox.innerHTML = `
                    <div class="modelo-box">
                        <div class="modelo-title">Cálculo Modelo 130</div>
                        <div class="row-item">
                            <span>Ingresos del trimestre:</span>
                            <strong>${totalIng.toFixed(2)} €</strong>
                        </div>
                        <div class="row-item">
                            <span>Gastos deducibles:</span>
                            <strong>${gastosDeducibles.toFixed(2)} €</strong>
                        </div>
                        <div class="row-item">
                            <span>Rendimiento neto:</span>
                            <strong>${rendNeto.toFixed(2)} €</strong>
                        </div>
                        <div class="row-item">
                            <span>Pago fraccionado (20%):</span>
                            <strong>${pago20.toFixed(2)} €</strong>
                        </div>
                        <div class="row-item">
                            <span>Retenciones soportadas:</span>
                            <strong>${retenciones.toFixed(2)} €</strong>
                        </div>
                        <div class="row-item total">
                            <span>RESULTADO A INGRESAR</span>
                            <strong>${resultado.toFixed(2)} €</strong>
                        </div>
                    </div>
                `;
            }
            
            mostrarAlerta130(trimestre);
        }
        
        function mostrarAlerta130(trimestre) {
            const alertaBox = document.getElementById('alerta130Box');
            const fechasLimite = {
                '4-2025': '2026-01-20',
                '1-2026': '2026-04-20',
                '2-2026': '2026-07-20',
                '3-2026': '2026-10-20',
                '4-2026': '2027-01-20'
            };
            
            const fechaLimite = new Date(fechasLimite[trimestre]);
            const hoy = new Date();
            const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
            
            if (diasRestantes > 0 && diasRestantes <= 30) {
                let claseAlerta = 'alert-vencimiento';
                if (diasRestantes <= 10) claseAlerta += ' alert-urgente';
                else if (diasRestantes <= 20) claseAlerta += ' alert-preparar';
                
                alertaBox.innerHTML = `
                    <div class="${claseAlerta}">
                        Vence el ${fechaLimite.toLocaleDateString('es-ES')} - Faltan ${diasRestantes} días
                    </div>
                `;
            } else {
                alertaBox.innerHTML = '';
            }
        }
        
        // ==================== RESUMEN ANUAL ====================
        function actualizarResumen() {
            const amazon = facturas.filter(f => f.tipo === 'amazon').reduce((sum, f) => sum + f.base, 0);
            const upwork = facturas.filter(f => f.tipo === 'upwork').reduce((sum, f) => sum + f.base, 0);
            const stripe = facturas.filter(f => f.tipo === 'stripe').reduce((sum, f) => sum + f.base, 0);
            const otros = facturas.filter(f => f.tipo === 'otros').reduce((sum, f) => sum + f.base, 0);
            const totalIng = amazon + upwork + stripe + otros;
            
            document.getElementById('res_amazon').textContent = amazon.toFixed(2) + ' €';
            document.getElementById('res_upwork').textContent = upwork.toFixed(2) + ' €';
            document.getElementById('res_stripe').textContent = stripe.toFixed(2) + ' €';
            document.getElementById('res_otros').textContent = otros.toFixed(2) + ' €';
            document.getElementById('res_totalIng').textContent = totalIng.toFixed(2) + ' €';
            
            const cuota = gastos.filter(g => g.categoria === 'cuota_ss').reduce((sum, g) => sum + g.base, 0);
            const comisiones = gastos.filter(g => g.categoria.includes('comisiones')).reduce((sum, g) => sum + g.base, 0);
            const software = gastos.filter(g => g.categoria === 'software').reduce((sum, g) => sum + g.base, 0);
            const publicidad = gastos.filter(g => g.categoria === 'publicidad').reduce((sum, g) => sum + g.base, 0);
            const otrosGastos = gastos.filter(g => !['cuota_ss', 'software', 'publicidad'].includes(g.categoria) && !g.categoria.includes('comisiones')).reduce((sum, g) => sum + g.base, 0);
            const totalGastos = gastos.reduce((sum, g) => sum + (g.base * g.porcDeducible / 100), 0);
            
            document.getElementById('res_cuota').textContent = cuota.toFixed(2) + ' €';
            document.getElementById('res_comisiones').textContent = comisiones.toFixed(2) + ' €';
            document.getElementById('res_software').textContent = software.toFixed(2) + ' €';
            document.getElementById('res_publicidad').textContent = publicidad.toFixed(2) + ' €';
            document.getElementById('res_otrosGastos').textContent = otrosGastos.toFixed(2) + ' €';
            document.getElementById('res_totalGastos').textContent = totalGastos.toFixed(2) + ' €';
            
            const beneficio = totalIng - totalGastos;
            const ivaRep = facturas.reduce((sum, f) => sum + f.iva, 0);
            const ivaSop = gastos.reduce((sum, g) => sum + (g.iva * g.porcDeducible / 100), 0);
            const retenciones = facturas.reduce((sum, f) => sum + f.retencion, 0);
            
            document.getElementById('res_beneficio').textContent = beneficio.toFixed(2) + ' €';
            document.getElementById('res_ivaRep').textContent = ivaRep.toFixed(2) + ' €';
            document.getElementById('res_ivaSop').textContent = ivaSop.toFixed(2) + ' €';
            document.getElementById('res_retenciones').textContent = retenciones.toFixed(2) + ' €';
            document.getElementById('res_numFacturas').textContent = facturas.length;
            document.getElementById('res_numGastos').textContent = gastos.length;
        }
        
        // ==================== ESTADOS MODELOS ====================
        function guardarEstadoModelo(modelo, periodo, presentado) {
            const key = `${modelo}_${periodo}`;
            estadosModelos[key] = presentado;
            localStorage.setItem('estadosModelos', JSON.stringify(estadosModelos));
            actualizarCalendarioFiscal();
        }
        
        function cargarEstadosModelos() {
            const check303 = document.getElementById('check303_4_2025');
            const check130 = document.getElementById('check130_4_2025');
            
            if (check303) check303.checked = estadosModelos['303_4-2025'] || false;
            if (check130) check130.checked = estadosModelos['130_4-2025'] || false;
        }
        
        // ==================== CALENDARIO FISCAL ====================
        function actualizarCalendarioFiscal() {
            const obligaciones = [
                { fecha: '2026-01-20', modelos: '303 + 130', periodo: '4T 2025', clave303: '303_4-2025', clave130: '130_4-2025' },
                { fecha: '2026-01-30', modelos: '390', periodo: 'Anual 2025', clave303: '390_2025' },
                { fecha: '2026-04-20', modelos: '303 + 130', periodo: '1T 2026', clave303: '303_1-2026', clave130: '130_1-2026' },
                { fecha: '2026-06-30', modelos: '100 (Renta)', periodo: 'Anual 2025', clave303: '100_2025' },
                { fecha: '2026-07-20', modelos: '303 + 130', periodo: '2T 2026', clave303: '303_2-2026', clave130: '130_2-2026' },
                { fecha: '2026-10-20', modelos: '303 + 130', periodo: '3T 2026', clave303: '303_3-2026', clave130: '130_3-2026' }
            ];
            
            const hoy = new Date();
            let proximaObligacion = null;
            
            const tbody = document.getElementById('tablaCalendario');
            tbody.innerHTML = obligaciones.map(obl => {
                const fechaLimite = new Date(obl.fecha);
                const diasRestantes = Math.ceil((fechaLimite - hoy) / (1000 * 60 * 60 * 24));
                
                if (!proximaObligacion && diasRestantes > 0) {
                    proximaObligacion = { ...obl, diasRestantes };
                }
                
                const presentado303 = estadosModelos[obl.clave303] || false;
                const presentado130 = obl.clave130 ? (estadosModelos[obl.clave130] || false) : true;
                const todoPresentado = presentado303 && presentado130;
                
                const estadoHTML = todoPresentado 
                    ? '<span class="estado-presentado">Presentado</span>'
                    : '<span class="estado-pendiente">Pendiente</span>';
                
                let diasHTML = diasRestantes > 0 
                    ? `<strong style="color: ${diasRestantes <= 10 ? '#FF3B30' : diasRestantes <= 20 ? '#FF9500' : '#34C759'};">${diasRestantes} días</strong>`
                    : '<span style="color: #86868B;">Pasado</span>';
                
                return `
                    <tr style="${diasRestantes > 0 && diasRestantes <= 10 ? 'background: #FFF4F4;' : ''}">
                        <td><strong>${new Date(obl.fecha).toLocaleDateString('es-ES')}</strong></td>
                        <td>${diasHTML}</td>
                        <td>${obl.modelos}</td>
                        <td>${obl.periodo}</td>
                        <td>${estadoHTML}</td>
                    </tr>
                `;
            }).join('');
            
            // Destacar próxima obligación
            const destacadoBox = document.getElementById('proximaObligacionDestacada');
            if (proximaObligacion) {
                destacadoBox.innerHTML = `
                    <div class="countdown-box" style="margin: 24px 0;">
                        <div class="countdown-label">Próxima Obligación</div>
                        <div class="countdown-days">${proximaObligacion.diasRestantes}</div>
                        <div style="font-size: 1.1em; opacity: 0.9; margin-top: 8px;">días restantes</div>
                        <div style="margin-top: 20px; font-size: 1.05em;">
                            <strong>${proximaObligacion.modelos}</strong> - ${proximaObligacion.periodo}
                        </div>
                        <div style="margin-top: 12px; opacity: 0.9;">Vencimiento: ${new Date(proximaObligacion.fecha).toLocaleDateString('es-ES')}</div>
                    </div>
                `;
            }
        }
        
        // ==================== BACKUP ====================
        function actualizarStatsBackup() {
            const totalIngresos = facturas.reduce((sum, f) => sum + f.base, 0);
            document.getElementById('stat_facturas').textContent = facturas.length;
            document.getElementById('stat_gastos').textContent = gastos.length;
            document.getElementById('stat_ingresos').textContent = totalIngresos.toFixed(0);
        }
        
        function exportarDatos() {
            const datos = {
                facturas,
                gastos,
                estadosModelos,
                exportado: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-fiscal-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✓ Copia de seguridad exportada correctamente');
        }
        
        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            
            // Hoja Facturas
            const facturasData = facturas.map(f => ({
                'Fecha': new Date(f.fecha).toLocaleDateString('es-ES'),
                'Número': f.numero,
                'Tipo': f.tipo,
                'Cliente': f.cliente,
                'Descripción': f.descripcion,
                'Base Imponible': f.base,
                'IVA %': f.porcIVA,
                'IVA €': f.iva,
                'Retención %': f.porcRetencion,
                'Retención €': f.retencion,
                'Total': f.total
            }));
            const wsFacturas = XLSX.utils.json_to_sheet(facturasData);
            XLSX.utils.book_append_sheet(wb, wsFacturas, 'Facturas');
            
            // Hoja Gastos
            const gastosData = gastos.map(g => ({
                'Fecha': new Date(g.fecha).toLocaleDateString('es-ES'),
                'Categoría': g.categoria,
                'Proveedor': g.proveedor,
                'Concepto': g.concepto,
                'Base Imponible': g.base,
                'IVA %': g.porcIVA,
                'IVA €': g.iva,
                'Total': g.total,
                '% Deducible': g.porcDeducible,
                'Nº Factura': g.numero
            }));
            const wsGastos = XLSX.utils.json_to_sheet(gastosData);
            XLSX.utils.book_append_sheet(wb, wsGastos, 'Gastos');
            
            // Hoja Resumen
            const totalIngresos = facturas.reduce((sum, f) => sum + f.base, 0);
            const totalGastos = gastos.reduce((sum, g) => sum + (g.base * g.porcDeducible / 100), 0);
            const beneficio = totalIngresos - totalGastos;
            const ivaRep = facturas.reduce((sum, f) => sum + f.iva, 0);
            const ivaSop = gastos.reduce((sum, g) => sum + (g.iva * g.porcDeducible / 100), 0);
            const retenciones = facturas.reduce((sum, f) => sum + f.retencion, 0);
            
            const resumenData = [
                { 'Concepto': 'Total Ingresos', 'Importe': totalIngresos },
                { 'Concepto': 'Total Gastos', 'Importe': totalGastos },
                { 'Concepto': 'Beneficio Neto', 'Importe': beneficio },
                { 'Concepto': 'IVA Repercutido', 'Importe': ivaRep },
                { 'Concepto': 'IVA Soportado', 'Importe': ivaSop },
                { 'Concepto': 'Saldo IVA', 'Importe': ivaRep - ivaSop },
                { 'Concepto': 'Retenciones IRPF', 'Importe': retenciones },
                { 'Concepto': 'Nº Facturas', 'Importe': facturas.length },
                { 'Concepto': 'Nº Gastos', 'Importe': gastos.length }
            ];
            const wsResumen = XLSX.utils.json_to_sheet(resumenData);
            XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');
            
            XLSX.writeFile(wb, `datos-fiscales-${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert('✓ Excel exportado correctamente');
        }
        
        function importarDatos(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    
                    if (confirm('¿Estás seguro? Esto reemplazará todos tus datos actuales.')) {
                        facturas = datos.facturas || [];
                        gastos = datos.gastos || [];
                        estadosModelos = datos.estadosModelos || {};
                        
                        localStorage.setItem('facturas', JSON.stringify(facturas));
                        localStorage.setItem('gastos', JSON.stringify(gastos));
                        localStorage.setItem('estadosModelos', JSON.stringify(estadosModelos));
                        
                        actualizarListaFacturas();
                        actualizarListaGastos();
                        actualizarDashboard();
                        cargarEstadosModelos();
                        actualizarCalendarioFiscal();
                        
                        alert('✓ Datos importados correctamente');
                        location.reload();
                    }
                } catch (error) {
                    alert('Error al importar datos. Verifica que el archivo sea válido.');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
                '
